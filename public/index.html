<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaWi Chatbot Monitor</title>
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --surface2: #1c2333;
  --border: #30363d; --text: #e6edf3; --text-dim: #8b949e;
  --accent: #58a6ff; --green: #3fb950; --orange: #d29922;
  --red: #f85149; --purple: #bc8cff; --cyan: #39d2c0;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif; font-size:13px; height:100vh; overflow:hidden; }
.app { display:grid; grid-template-rows:42px 1fr; height:100vh; }

/* Header */
.header { background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 16px; gap:12px; }
.header h1 { font-size:14px; font-weight:600; white-space:nowrap; }
.header h1 span { color:var(--accent); }
.header-stats { display:flex; gap:14px; margin-left:auto; font-size:12px; color:var(--text-dim); }
.header-stats .sv { color:var(--text); font-weight:600; }
.hbtn { padding:3px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.hbtn:hover { border-color:var(--text-dim); color:var(--text); }
.hbtn.danger:hover { border-color:var(--red); color:var(--red); }
.cdot { width:8px; height:8px; border-radius:50%; background:var(--red); transition:background .3s; }
.cdot.on { background:var(--green); }

/* 3-panel layout */
.panels { display:grid; grid-template-columns:280px 1fr 300px; overflow:hidden; }
.panel { border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
.panel:last-child { border-right:none; }
.panel-hdr { padding:8px 12px; background:var(--surface); border-bottom:1px solid var(--border); font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); display:flex; align-items:center; gap:8px; flex-shrink:0; }
.panel-body { flex:1; overflow-y:auto; padding:8px; }
.panel-body::-webkit-scrollbar { width:6px; }
.panel-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* Tabs */
.tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; background:var(--surface); }
.tab { padding:6px 14px; border:none; background:transparent; color:var(--text-dim); font-size:12px; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; position:relative; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab .tbadge { position:absolute; top:2px; right:4px; background:var(--accent); color:#fff; font-size:9px; padding:0 4px; border-radius:6px; min-width:14px; text-align:center; }
.tab .tbadge.red { background:var(--red); }
.tab .tbadge.hide { display:none; }

/* Feed */
.ffilters { display:flex; gap:4px; padding:6px 8px; border-bottom:1px solid var(--border); flex-wrap:wrap; flex-shrink:0; }
.fbtn { padding:2px 8px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.fbtn:hover { border-color:var(--text-dim); }
.fbtn.on { background:var(--accent); color:#fff; border-color:var(--accent); }
.fbtn.on-red { background:var(--red); color:#fff; border-color:var(--red); }
.fi { padding:8px 10px; border-radius:6px; margin-bottom:4px; cursor:pointer; transition:background .1s; border-left:3px solid transparent; }
.fi:hover { background:var(--surface2); }
.fi.sel { background:var(--surface2); border-left-color:var(--accent); }
.fi.flagged { border-left-color:var(--red); }
.fi .ft { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.3px; margin-bottom:2px; }
.fi .ft.chat { color:var(--accent); } .fi .ft.query { color:var(--purple); }
.fi .ft.error { color:var(--red); } .fi .ft.system { color:var(--text-dim); }
.fi .fp { color:var(--text-dim); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.fi .fm { display:flex; gap:8px; font-size:10px; color:var(--text-dim); margin-top:2px; }

/* Chat */
.cmsg { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }
.cmsg::-webkit-scrollbar { width:6px; } .cmsg::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.cempty { display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-dim); font-size:13px; flex-direction:column; gap:8px; }
.bubble { padding:10px 14px; border-radius:12px; max-width:85%; line-height:1.5; font-size:13px; word-wrap:break-word; white-space:pre-wrap; }
.bubble.q { background:#1f3a5f; border:1px solid #264a78; align-self:flex-end; border-bottom-right-radius:4px; }
.bubble.a { background:var(--surface2); border:1px solid var(--border); align-self:flex-start; border-bottom-left-radius:4px; }
.bubble .bl { font-size:10px; font-weight:600; text-transform:uppercase; margin-bottom:4px; color:var(--text-dim); }
.bubble .bm { font-size:10px; color:var(--text-dim); margin-top:4px; display:flex; gap:8px; }
.cinput { padding:10px; border-top:1px solid var(--border); background:var(--surface); flex-shrink:0; }
.crow { display:flex; gap:6px; align-items:flex-end; }
.cin { flex:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; font-family:inherit; outline:none; resize:none; min-height:38px; max-height:120px; }
.cin:focus { border-color:var(--accent); }
.cin::placeholder { color:var(--text-dim); }
.csend { padding:8px 16px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-size:13px; font-weight:600; cursor:pointer; min-height:38px; transition:opacity .15s; }
.csend:hover { opacity:.85; } .csend:disabled { opacity:.4; cursor:not-allowed; }
.ccfg { display:flex; gap:8px; margin-top:6px; align-items:center; }
.ccfg select,.ccfg input { padding:3px 8px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:11px; outline:none; }
.ccfg label { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; }
.cthink { align-self:flex-start; padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:12px; border-bottom-left-radius:4px; color:var(--text-dim); }
.dots { display:inline-flex; gap:4px; }
.dots span { width:6px; height:6px; border-radius:50%; background:var(--text-dim); animation:pulse 1.4s infinite both; }
.dots span:nth-child(2) { animation-delay:.2s; } .dots span:nth-child(3) { animation-delay:.4s; }
@keyframes pulse { 0%,80%,100%{opacity:.3;transform:scale(.8)} 40%{opacity:1;transform:scale(1)} }

/* Detail */
.dempty { display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-dim); }
.badge { display:inline-block; padding:1px 6px; border-radius:8px; font-size:10px; font-weight:600; }
.bmod { background:#1c3a2a; color:var(--green); } .btime { background:#1a2332; color:var(--accent); }
.bfast { background:#1c3a2a; color:var(--green); } .bmed { background:#2a2310; color:var(--orange); }
.bslow { background:#2a1515; color:var(--red); } .berr { background:#2a1515; color:var(--red); }
.buser { background:#1a2332; color:var(--cyan); }
.dmeta { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; padding:0 4px; }
.mbar { display:flex; gap:6px; padding:8px; border-top:1px solid var(--border); flex-shrink:0; }
.mbtn { padding:4px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.mbtn:hover { border-color:var(--text-dim); color:var(--text); }
.mbtn.fon { background:#2a1515; border-color:var(--red); color:var(--red); }
.mbtn.ron { background:#1c3a2a; border-color:var(--green); color:var(--green); }
.nin { flex:1; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:11px; outline:none; }
.nin:focus { border-color:var(--accent); }

/* SQL */
.sqlb { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:8px; font-family:'Cascadia Code','Fira Code',Consolas,monospace; font-size:12px; white-space:pre-wrap; word-break:break-all; }
.sk { color:var(--purple); font-weight:600; } .ss { color:var(--green); } .sn { color:var(--orange); }
.rtbl { width:100%; border-collapse:collapse; font-size:11px; margin-top:6px; }
.rtbl th { background:var(--surface); padding:4px 8px; text-align:left; border:1px solid var(--border); color:var(--accent); font-weight:600; }
.rtbl td { padding:3px 8px; border:1px solid var(--border); color:var(--text-dim); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.rtbl tr:hover td { background:var(--surface2); }
.qerr { background:#2a1515; border:1px solid var(--red); border-radius:6px; padding:8px 10px; color:var(--red); font-size:12px; margin-top:6px; }

/* Users panel */
.uitem { padding:8px 10px; border-radius:6px; margin-bottom:4px; cursor:pointer; transition:background .1s; display:flex; align-items:center; gap:8px; }
.uitem:hover { background:var(--surface2); }
.uitem.sel { background:var(--surface2); }
.udot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.udot.active { background:var(--green); } .udot.blocked { background:var(--red); } .udot.restricted { background:var(--orange); }
.uinfo { flex:1; min-width:0; }
.uname { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.umeta { font-size:10px; color:var(--text-dim); }
.ustatus { font-size:10px; font-weight:600; padding:1px 6px; border-radius:6px; }
.ustatus.active { background:#1c3a2a; color:var(--green); }
.ustatus.blocked { background:#2a1515; color:var(--red); }
.ustatus.restricted { background:#2a2310; color:var(--orange); }

/* User detail */
.udetail { padding:8px; }
.ucard { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px; }
.ucard h3 { font-size:14px; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.ucard .ustat-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.ucard .ustat-item { font-size:11px; color:var(--text-dim); }
.ucard .ustat-item strong { color:var(--text); }
.ubtn { padding:6px 14px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:12px; cursor:pointer; transition:all .15s; font-weight:600; }
.ubtn:hover { color:var(--text); border-color:var(--text-dim); }
.ubtn.block { color:var(--red); border-color:var(--red); }
.ubtn.block:hover { background:#2a1515; }
.ubtn.unblock { color:var(--green); border-color:var(--green); }
.ubtn.unblock:hover { background:#1c3a2a; }
.uevt { padding:6px 8px; border-radius:6px; margin-bottom:3px; background:var(--surface); border:1px solid var(--border); font-size:11px; cursor:pointer; }
.uevt:hover { background:var(--surface2); }

/* Stats */
.sc { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 12px; margin-bottom:8px; }
.sc .sl { font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); margin-bottom:4px; }
.sc .sv { font-size:22px; font-weight:700; }
.sc .ssub { font-size:11px; color:var(--text-dim); margin-top:2px; }
.sgrid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px; }
.sgrid .sc { margin-bottom:0; } .sgrid .sc .sv { font-size:18px; }
.barchart { display:flex; align-items:flex-end; gap:2px; height:60px; padding:4px 0; }
.bar { flex:1; background:var(--accent); border-radius:2px 2px 0 0; min-height:2px; position:relative; opacity:.7; transition:opacity .15s; }
.bar:hover { opacity:1; }
.bar:hover::after { content:attr(data-label); position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:var(--surface); border:1px solid var(--border); padding:2px 6px; border-radius:4px; font-size:10px; white-space:nowrap; color:var(--text); z-index:10; }
.tlist { display:flex; flex-wrap:wrap; gap:4px; }
.ttag { padding:2px 8px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; font-size:11px; color:var(--text-dim); }
.stitle { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); margin:12px 0 6px; }
.edetail { background:#1a0f0f; border:1px solid var(--red); border-radius:8px; padding:12px; }
.sysdetail { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:12px; }

/* Settings modal */
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:100; align-items:center; justify-content:center; }
.modal.open { display:flex; }
.mbox { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; width:420px; max-width:90vw; }
.mbox h2 { font-size:15px; margin-bottom:14px; }
.mf { margin-bottom:12px; }
.mf label { display:block; font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; margin-bottom:4px; }
.mf input,.mf textarea,.mf select { width:100%; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:12px; font-family:inherit; outline:none; }
.mf textarea { min-height:60px; resize:vertical; }
.mf input:focus,.mf textarea:focus { border-color:var(--accent); }
.mactions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
.mactions button { padding:6px 16px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:12px; cursor:pointer; transition:all .15s; }
.mactions button:hover { color:var(--text); border-color:var(--text-dim); }
.mactions button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }

@media (max-width:1100px) { .panels { grid-template-columns:240px 1fr 260px; } }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1><span>WaWi</span> Chatbot Monitor</h1>
    <div class="header-stats">
      <span>Users: <span class="sv" id="hUsers">0</span></span>
      <span>Chats: <span class="sv" id="hChats">0</span></span>
      <span>Errors: <span class="sv" id="hErrors">0</span></span>
      <span>Avg: <span class="sv" id="hAvg">0ms</span></span>
    </div>
    <button class="hbtn" onclick="openSettings()">Settings</button>
    <button class="hbtn danger" onclick="clearEvents()">Clear All</button>
    <div class="cdot" id="connDot" title="Disconnected"></div>
  </div>

  <div class="panels">
    <!-- LEFT: Feed -->
    <div class="panel">
      <div class="panel-hdr">Live Feed <span id="feedCount" style="margin-left:auto;color:var(--accent)">0</span></div>
      <div class="ffilters" id="feedFilters">
        <button class="fbtn on" data-f="all">All</button>
        <button class="fbtn" data-f="chat">Chat</button>
        <button class="fbtn" data-f="query">SQL</button>
        <button class="fbtn" data-f="error">Errors</button>
        <button class="fbtn" data-f="flagged">Flagged</button>
      </div>
      <div class="panel-body" id="feedBody"></div>
    </div>

    <!-- CENTER: Chat / Detail / SQL -->
    <div class="panel">
      <div class="tabs" id="centerTabs">
        <button class="tab active" data-t="chat" onclick="cTab('chat')">Chat</button>
        <button class="tab" data-t="detail" onclick="cTab('detail')">Detail</button>
        <button class="tab" data-t="sql" onclick="cTab('sql')">SQL <span class="tbadge hide" id="sqlBadge">0</span></button>
      </div>
      <div id="tChat" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="cmsg" id="chatMessages"><div class="cempty"><div>Ask the chatbot anything</div><div style="font-size:11px;opacity:.6">Messages go to your local Ollama</div></div></div>
        <div class="cinput">
          <div class="crow">
            <textarea class="cin" id="chatInput" rows="1" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
            <button class="csend" id="chatSendBtn" onclick="sendChat()">Send</button>
          </div>
          <div class="ccfg">
            <label>Model</label><select id="modelSel"><option>loading...</option></select>
            <label style="margin-left:8px">User</label><input id="chatUid" value="admin" style="width:80px">
          </div>
        </div>
      </div>
      <div id="tDetail" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="detailBody"><div class="dempty">Select an event from the feed</div></div>
        <div class="mbar" id="modBar" style="display:none">
          <button class="mbtn" id="btnFlag" onclick="toggleFlag()">Flag</button>
          <button class="mbtn" id="btnReview" onclick="toggleReview()">Reviewed</button>
          <input class="nin" id="noteIn" placeholder="Add note..." onkeydown="if(event.key==='Enter')saveNote()">
          <button class="mbtn" onclick="saveNote()">Save</button>
        </div>
      </div>
      <div id="tSql" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="sqlBody"><div class="dempty">SQL queries will appear here</div></div>
      </div>
    </div>

    <!-- RIGHT: Users / Stats -->
    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-t="users" onclick="rTab('users')">Users <span class="tbadge hide" id="usersBadge">0</span></button>
        <button class="tab" data-t="stats" onclick="rTab('stats')">Stats</button>
      </div>
      <div id="tUsers" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="usersBody"><div class="dempty">No users yet</div></div>
      </div>
      <div id="tStats" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="statsBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="mbox">
    <h2>Chatbot Settings</h2>
    <div class="mf"><label>Ollama URL</label><input id="cfgUrl" value="http://localhost:11434"></div>
    <div class="mf"><label>Default Model</label><select id="cfgModel"><option>loading...</option></select></div>
    <div class="mf"><label>System Prompt</label><textarea id="cfgPrompt" placeholder="e.g. Du bist ein WaWi-Assistent."></textarea></div>
    <div class="mf"><label>Temperature</label><input id="cfgTemp" type="number" min="0" max="2" step="0.1" value="0.7"></div>
    <div class="mactions"><button onclick="closeSettings()">Cancel</button><button class="primary" onclick="saveSettings()">Save</button></div>
  </div>
</div>

<script>
let events=[],moderation={},usersMap={},selectedId=null,selectedUser=null;
let activeFilter='all',centerTab='chat',rightTab='users';
let connected=false,sending=false,chatHistory=[],ollamaModels=[],appCfg={};

// ---- SSE ----
function connectSSE(){
  const es=new EventSource('/api/stream'),dot=$('connDot');
  es.onopen=()=>{connected=true;dot.className='cdot on';dot.title='Connected'};
  es.onerror=()=>{connected=false;dot.className='cdot';dot.title='Reconnecting...'};
  es.addEventListener('init',e=>{events=JSON.parse(e.data);renderFeed();renderSql();refreshStats()});
  es.addEventListener('moderation',e=>{moderation=JSON.parse(e.data);renderFeed();if(selectedId)renderDetail(selectedId)});
  es.addEventListener('users',e=>{usersMap=JSON.parse(e.data);renderUsers()});
  es.onmessage=e=>{
    const evt=JSON.parse(e.data);
    if(evt.type==='_clear'){events=[];moderation={};selectedId=null;renderFeed();renderSql();refreshStats();$('detailBody').innerHTML='<div class="dempty">Select an event</div>';$('modBar').style.display='none';return}
    if(evt.type==='_moderation_update'){moderation[evt.event_id]=evt.moderation;renderFeed();if(selectedId===evt.event_id)renderDetail(selectedId);refreshStats();return}
    if(evt.type==='_user_update'){if(usersMap[evt.user_id])usersMap[evt.user_id].status=evt.status;renderUsers();if(selectedUser===evt.user_id)showUserDetail(evt.user_id);return}
    events.push(evt);if(events.length>5000)events.shift();
    addFeedItem(evt);if(evt.type==='query')addSqlItem(evt);
    // Update user in local map
    if(evt.user_id&&evt.user_id!=='admin'){
      if(!usersMap[evt.user_id])usersMap[evt.user_id]={user_id:evt.user_id,status:'active',first_seen:evt.timestamp,last_seen:evt.timestamp,message_count:0};
      usersMap[evt.user_id].last_seen=evt.timestamp;
      if(evt.type==='chat')usersMap[evt.user_id].message_count=(usersMap[evt.user_id].message_count||0)+1;
      renderUsers();
    }
    refreshStats();
  };
}

// ---- Tabs ----
function cTab(t){centerTab=t;document.querySelectorAll('#centerTabs .tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));$('tChat').style.display=t==='chat'?'flex':'none';$('tDetail').style.display=t==='detail'?'flex':'none';$('tSql').style.display=t==='sql'?'flex':'none';if(t==='chat')$('chatInput').focus()}
function rTab(t){rightTab=t;document.querySelectorAll('.panel:last-child .tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));$('tUsers').style.display=t==='users'?'flex':'none';$('tStats').style.display=t==='stats'?'flex':'none'}

// ---- Chat ----
async function sendChat(){
  if(sending)return;const inp=$('chatInput'),q=inp.value.trim();if(!q)return;
  const model=$('modelSel').value,uid=$('chatUid').value||'admin';
  chatHistory.push({role:'user',content:q});renderChatMsgs();inp.value='';inp.style.height='auto';
  sending=true;$('chatSendBtn').disabled=true;
  const th=document.createElement('div');th.className='cthink';th.id='thinkInd';th.innerHTML='<div class="dots"><span></span><span></span><span></span></div>';$('chatMessages').appendChild(th);scrollChat();
  try{
    const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,model,user_id:uid})});
    const d=await r.json();$('thinkInd')?.remove();
    if(d.ok)chatHistory.push({role:'bot',content:d.answer,model:d.model,ms:d.duration_ms});
    else chatHistory.push({role:'error',content:d.error||'Unknown error'});
  }catch(err){$('thinkInd')?.remove();chatHistory.push({role:'error',content:err.message})}
  sending=false;$('chatSendBtn').disabled=false;renderChatMsgs();$('chatInput').focus();
}
function renderChatMsgs(){
  const c=$('chatMessages');
  if(!chatHistory.length){c.innerHTML='<div class="cempty"><div>Ask the chatbot anything</div><div style="font-size:11px;opacity:.6">Messages go to your local Ollama</div></div>';return}
  c.innerHTML=chatHistory.map(m=>{
    if(m.role==='user')return`<div class="bubble q"><div class="bl">You</div>${esc(m.content)}</div>`;
    if(m.role==='error')return`<div class="bubble a" style="border-color:var(--red)"><div class="bl" style="color:var(--red)">Error</div>${esc(m.content)}</div>`;
    return`<div class="bubble a"><div class="bl">Bot</div>${esc(m.content)}<div class="bm">${m.model?`<span>${esc(m.model)}</span>`:''}${m.ms?`<span>${fmtDur(m.ms)}</span>`:''}</div></div>`;
  }).join('');scrollChat();
}
function scrollChat(){const c=$('chatMessages');c.scrollTop=c.scrollHeight}
$('chatInput').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'});

// ---- Feed ----
function renderFeed(){$('feedBody').innerHTML='';getFiltered().forEach(e=>addFeedItem(e,false));scrollFeed()}
function getFiltered(){
  if(activeFilter==='all')return events.filter(e=>!e.type.startsWith('_'));
  if(activeFilter==='flagged')return events.filter(e=>moderation[e.id]?.flagged);
  return events.filter(e=>e.type===activeFilter);
}
function addFeedItem(evt,scroll=true){
  if(evt.type.startsWith('_'))return;
  if(activeFilter!=='all'){if(activeFilter==='flagged'){if(!moderation[evt.id]?.flagged)return}else if(evt.type!==activeFilter)return}
  const body=$('feedBody'),d=document.createElement('div');
  d.className='fi'+(evt.id===selectedId?' sel':'')+(moderation[evt.id]?.flagged?' flagged':'');
  d.dataset.id=evt.id;d.onclick=()=>{selectEvent(evt.id);cTab('detail')};
  const fl=moderation[evt.id]?.flagged?' <span style="color:var(--red)">&#9873;</span>':'';
  d.innerHTML=`<div class="ft ${evt.type}">${evt.type}${fl}</div><div class="fp">${esc(preview(evt))}</div><div class="fm"><span>${fmtTime(evt.timestamp)}</span>${evt.user_id?`<span>${esc(evt.user_id)}</span>`:''}${evt.duration_ms?`<span>${evt.duration_ms}ms</span>`:''}</div>`;
  body.appendChild(d);$('feedCount').textContent=body.children.length;if(scroll)scrollFeed();
}
function preview(e){switch(e.type){case'chat':return e.question||'';case'query':return e.sql||'';case'error':return e.message||'';case'system':return`[${e.action||''}] ${e.message||''}`;default:return JSON.stringify(e).slice(0,80)}}
function scrollFeed(){const b=$('feedBody');b.scrollTop=b.scrollHeight}
$('feedFilters').addEventListener('click',e=>{if(!e.target.classList.contains('fbtn'))return;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on','on-red'));const f=e.target.dataset.f;e.target.classList.add(f==='flagged'?'on-red':'on');activeFilter=f;renderFeed()});

// ---- Detail ----
function selectEvent(id){selectedId=id;document.querySelectorAll('.fi').forEach(el=>el.classList.toggle('sel',el.dataset.id===id));renderDetail(id)}
function renderDetail(id){
  const evt=events.find(e=>e.id===id);if(!evt)return;
  const body=$('detailBody'),mb=$('modBar');mb.style.display='flex';
  const mod=moderation[id]||{};
  $('btnFlag').className='mbtn'+(mod.flagged?' fon':'');$('btnFlag').textContent=mod.flagged?'Unflag':'Flag';
  $('btnReview').className='mbtn'+(mod.reviewed?' ron':'');$('btnReview').textContent=mod.reviewed?'Reviewed':'Mark Reviewed';
  $('noteIn').value=mod.note||'';
  if(evt.type==='chat'){const tb=timeBadge(evt.duration_ms);body.innerHTML=`<div class="dmeta">${evt.model?`<span class="badge bmod">${esc(evt.model)}</span>`:''}${evt.duration_ms?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="bubble q" style="max-width:100%"><div class="bl">User</div>${esc(evt.question||'')}</div><div class="bubble a" style="max-width:100%"><div class="bl">Bot</div>${esc(evt.answer||'')}</div>`}
  else if(evt.type==='query'){const tb=timeBadge(evt.duration_ms);let h=`<div class="dmeta">${evt.duration_ms!=null?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="sqlb">${hlSQL(evt.sql||'')}</div>`;if(evt.error)h+=`<div class="qerr">${esc(evt.error)}</div>`;if(evt.results?.length>0)h+=rtbl(evt.results);body.innerHTML=h}
  else if(evt.type==='error'){body.innerHTML=`<div class="dmeta"><span class="badge berr">${esc(evt.error_type||'error')}</span>${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="edetail"><div style="color:var(--red);font-weight:600;font-size:14px;margin-bottom:6px">${esc(evt.error_type||'Error')}</div><div style="line-height:1.5">${esc(evt.message||'')}</div>${evt.details?`<div style="margin-top:8px;padding:8px;background:var(--surface);border-radius:6px;font-family:monospace;font-size:12px;color:var(--text-dim);white-space:pre-wrap">${esc(evt.details)}</div>`:''}</div>`}
  else{body.innerHTML=`<div class="dmeta"><span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="sysdetail"><div style="font-weight:600;font-size:14px;margin-bottom:6px">${esc(evt.action||'system')}</div><div style="color:var(--text-dim)">${esc(evt.message||'')}</div></div>`}
}

// ---- SQL ----
function renderSql(){
  const body=$('sqlBody'),qs=events.filter(e=>e.type==='query');
  const badge=$('sqlBadge');if(qs.length>0){badge.textContent=qs.length;badge.classList.remove('hide')}else{badge.classList.add('hide')}
  if(!qs.length){body.innerHTML='<div class="dempty">SQL queries will appear here</div>';return}
  body.innerHTML='';qs.slice(-50).forEach(e=>addSqlItem(e,false));body.scrollTop=body.scrollHeight;
}
function addSqlItem(evt,scroll=true){
  const body=$('sqlBody');if(body.querySelector('.dempty'))body.innerHTML='';
  const badge=$('sqlBadge'),cnt=events.filter(e=>e.type==='query').length;badge.textContent=cnt;badge.classList.remove('hide');
  const d=document.createElement('div');d.style.marginBottom='10px';const tb=timeBadge(evt.duration_ms);
  let h=`<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">${evt.duration_ms!=null?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span style="font-size:10px;color:var(--text-dim)">${fmtTime(evt.timestamp)}</span></div><div class="sqlb" style="cursor:pointer" onclick="selectEvent('${evt.id}');cTab('detail')">${hlSQL(evt.sql||'')}</div>`;
  if(evt.error)h+=`<div class="qerr">${esc(evt.error)}</div>`;else if(evt.results?.length>0)h+=rtbl(evt.results);
  d.innerHTML=h;body.appendChild(d);if(scroll)body.scrollTop=body.scrollHeight;
}
function rtbl(rows){if(!rows.length)return'';const cols=Object.keys(rows[0]);let h='<div style="overflow-x:auto"><table class="rtbl"><thead><tr>';cols.forEach(c=>h+=`<th>${esc(String(c))}</th>`);h+='</tr></thead><tbody>';rows.forEach(r=>{h+='<tr>';cols.forEach(c=>h+=`<td title="${esc(String(r[c]??''))}">${esc(String(r[c]??''))}</td>`);h+='</tr>'});h+='</tbody></table></div>';return h}

// ---- Users ----
function renderUsers(){
  const body=$('usersBody'),list=Object.values(usersMap).sort((a,b)=>(b.last_seen||0)-(a.last_seen||0));
  const badge=$('usersBadge');const blocked=list.filter(u=>u.status==='blocked').length;
  if(blocked>0){badge.textContent=blocked;badge.classList.remove('hide');badge.classList.add('red')}else{badge.classList.add('hide')}
  if(!list.length){body.innerHTML='<div class="dempty">No users yet</div>';return}
  body.innerHTML=list.map(u=>{
    const evts=events.filter(e=>e.user_id===u.user_id);
    const chatCount=evts.filter(e=>e.type==='chat').length;
    const lastAgo=u.last_seen?timeAgo(u.last_seen):'never';
    return`<div class="uitem${selectedUser===u.user_id?' sel':''}" onclick="showUserDetail('${esc(u.user_id)}')">
      <div class="udot ${u.status||'active'}"></div>
      <div class="uinfo"><div class="uname">${esc(u.user_id)}</div><div class="umeta">${chatCount} chats &middot; ${lastAgo}</div></div>
      <span class="ustatus ${u.status||'active'}">${u.status||'active'}</span>
    </div>`;
  }).join('');
}
function showUserDetail(uid){
  selectedUser=uid;renderUsers();
  const u=usersMap[uid]||{user_id:uid,status:'unknown'};
  const uevts=events.filter(e=>e.user_id===uid);
  const chats=uevts.filter(e=>e.type==='chat').length;
  const errs=uevts.filter(e=>e.type==='error').length;
  const queries=uevts.filter(e=>e.type==='query').length;
  const isBlocked=u.status==='blocked';
  const body=$('usersBody');
  body.innerHTML=`
    <div style="padding:4px">
      <button class="mbtn" onclick="selectedUser=null;renderUsers()" style="margin-bottom:8px">&larr; All Users</button>
      <div class="ucard">
        <h3><div class="udot ${u.status||'active'}" style="width:10px;height:10px"></div> ${esc(uid)}</h3>
        <div class="ustat-grid">
          <div class="ustat-item"><strong>${chats}</strong> chats</div>
          <div class="ustat-item"><strong>${queries}</strong> queries</div>
          <div class="ustat-item"><strong>${errs}</strong> errors</div>
          <div class="ustat-item"><strong>${uevts.length}</strong> total events</div>
          <div class="ustat-item">First: <strong>${u.first_seen?fmtTime(u.first_seen):'?'}</strong></div>
          <div class="ustat-item">Last: <strong>${u.last_seen?timeAgo(u.last_seen):'?'}</strong></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        ${isBlocked
          ?`<button class="ubtn unblock" onclick="userAction('${esc(uid)}','unblock')">Unblock User</button>`
          :`<button class="ubtn block" onclick="userAction('${esc(uid)}','block')">Block User</button>`}
      </div>
      ${u.note?`<div class="ucard"><div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">ADMIN NOTE</div><div style="font-size:12px">${esc(u.note)}</div></div>`:''}
      <div class="stitle">Recent Activity</div>
      ${uevts.slice(-20).reverse().map(e=>`<div class="uevt" onclick="selectEvent('${e.id}');cTab('detail')"><span class="ft ${e.type}" style="display:inline">${e.type}</span> <span style="color:var(--text-dim)">${esc(preview(e)).slice(0,60)}</span> <span style="font-size:10px;color:var(--text-dim);float:right">${fmtTime(e.timestamp)}</span></div>`).join('')}
      ${uevts.length===0?'<div style="color:var(--text-dim);font-size:11px">No activity</div>':''}
    </div>`;
}
async function userAction(uid,action){
  await fetch(`/api/users/${uid}/${action}`,{method:'POST'});
}

// ---- Stats ----
function refreshStats(){
  fetch('/api/stats').then(r=>r.json()).then(s=>{
    renderStats(s);$('hUsers').textContent=s.active_users;$('hChats').textContent=s.total_chats;$('hErrors').textContent=s.total_errors;$('hAvg').textContent=s.avg_response_ms+'ms';
  }).catch(()=>{});
}
function renderStats(s){
  $('statsBody').innerHTML=`
    <div class="sgrid">
      <div class="sc"><div class="sl">Active Users</div><div class="sv" style="color:var(--cyan)">${s.active_users}</div><div class="ssub">${s.total_users||0} total, ${s.blocked_users||0} blocked</div></div>
      <div class="sc"><div class="sl">Avg Response</div><div class="sv" style="color:${s.avg_response_ms>5000?'var(--red)':s.avg_response_ms>2000?'var(--orange)':'var(--green)'}">${fmtDur(s.avg_response_ms)}</div><div class="ssub">per chat</div></div>
      <div class="sc"><div class="sl">Error Rate</div><div class="sv" style="color:${s.error_rate>5?'var(--red)':s.error_rate>1?'var(--orange)':'var(--green)'}">${s.error_rate}%</div><div class="ssub">${s.total_errors} total</div></div>
      <div class="sc"><div class="sl">Msgs/Hour</div><div class="sv" style="color:var(--accent)">${s.messages_last_hour}</div><div class="ssub">${s.total_chats} total</div></div>
    </div>
    <div class="stitle">Hourly Volume (24h)</div><div class="sc" style="padding:8px">${barChart(s.hourly||{})}</div>
    <div class="stitle">Event Types</div><div class="sc" style="padding:8px">${typeBar(s.type_counts||{})}</div>
    <div class="stitle">Top Topics</div><div class="tlist" style="margin-bottom:12px">${(s.topics||[]).map(t=>`<span class="ttag">${esc(t)}</span>`).join('')||'<span style="color:var(--text-dim);font-size:11px">No topics yet</span>'}</div>
    <div class="stitle">Moderation</div><div class="sc"><div style="display:flex;gap:16px;font-size:12px"><span style="color:var(--red)">Flagged: ${s.flagged||0}</span><span style="color:var(--orange)">Unreviewed: ${s.unreviewed||0}</span><span style="color:var(--green)">Reviewed: ${s.reviewed||0}</span></div></div>`;
}
function barChart(h){const e=Object.entries(h);if(!e.length)return'<div style="color:var(--text-dim);font-size:11px;text-align:center;padding:10px">No data</div>';const mx=Math.max(...e.map(x=>x[1]),1);let r='<div class="barchart">';e.forEach(([hr,c])=>r+=`<div class="bar" style="height:${Math.max(c/mx*100,3)}%" data-label="${hr}: ${c}"></div>`);r+='</div><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim)"><span>'+e[0][0]+'</span>'+(e.length>1?'<span>'+e[e.length-1][0]+'</span>':'')+'</div>';return r}
function typeBar(c){const t=Object.values(c).reduce((a,b)=>a+b,0)||1;const cl={chat:'var(--accent)',query:'var(--purple)',error:'var(--red)',system:'var(--text-dim)'};let h='<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-bottom:6px">';Object.entries(c).forEach(([k,v])=>{if(v>0)h+=`<div style="width:${v/t*100}%;background:${cl[k]||'var(--text-dim)'}" title="${k}: ${v}"></div>`});h+='</div><div style="display:flex;gap:12px;flex-wrap:wrap">';Object.entries(c).forEach(([k,v])=>h+=`<span style="font-size:11px;color:${cl[k]||'var(--text-dim)'}">${k}: ${v}</span>`);h+='</div>';return h}

// ---- Moderation ----
function toggleFlag(){if(!selectedId)return;postMod(selectedId,{flagged:!(moderation[selectedId]?.flagged)})}
function toggleReview(){if(!selectedId)return;postMod(selectedId,{reviewed:!(moderation[selectedId]?.reviewed)})}
function saveNote(){if(!selectedId)return;postMod(selectedId,{note:$('noteIn').value})}
function postMod(id,d){fetch(`/api/moderate/${id}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(()=>{})}

// ---- Settings ----
function openSettings(){loadCfg();$('settingsModal').classList.add('open')}
function closeSettings(){$('settingsModal').classList.remove('open')}
async function loadCfg(){try{const r=await fetch('/api/config');const d=await r.json();appCfg=d.config;$('cfgUrl').value=appCfg.ollama_url||'http://localhost:11434';$('cfgPrompt').value=appCfg.system_prompt||'';$('cfgTemp').value=appCfg.temperature??0.7;await loadModels();$('cfgModel').value=appCfg.default_model||''}catch(e){}}
async function saveSettings(){const c={ollama_url:$('cfgUrl').value,default_model:$('cfgModel').value,system_prompt:$('cfgPrompt').value,temperature:parseFloat($('cfgTemp').value)||0.7};await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(c)});appCfg=c;closeSettings()}
async function loadModels(){try{const r=await fetch('/api/models');ollamaModels=(await r.json()).models||[]}catch(e){ollamaModels=[]}populateModels()}
function populateModels(){[$('modelSel'),$('cfgModel')].forEach(s=>{if(!s)return;const c=s.value;s.innerHTML='';if(!ollamaModels.length){s.innerHTML='<option value="">No models found</option>';return}ollamaModels.forEach(m=>{const o=document.createElement('option');o.value=m.name;o.textContent=m.name;s.appendChild(o)});if(c&&ollamaModels.some(m=>m.name===c))s.value=c;else if(appCfg.default_model)s.value=appCfg.default_model})}
function clearEvents(){if(!confirm('Clear all events? This cannot be undone.'))return;fetch('/api/clear',{method:'POST'})}

// ---- Helpers ----
function $(id){return document.getElementById(id)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fmtTime(ts){if(!ts)return'';return new Date(ts*1000).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
function fmtDur(ms){if(ms>=1000)return(ms/1000).toFixed(1)+'s';return Math.round(ms)+'ms'}
function timeBadge(ms){if(!ms)return'btime';if(ms<100)return'bfast';if(ms<500)return'bmed';return'bslow'}
function timeAgo(ts){const s=Math.floor(Date.now()/1000-ts);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}
function hlSQL(sql){let r=esc(sql);r=r.replace(/('[^']*')/g,'<span class="ss">$1</span>');r=r.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|IN|IS|NULL|AS|ORDER BY|GROUP BY|HAVING|LIMIT|OFFSET|INSERT|INTO|VALUES|UPDATE|SET|DELETE|CREATE|ALTER|DROP|TABLE|INDEX|COUNT|SUM|AVG|MIN|MAX|DISTINCT|BETWEEN|LIKE|UNION|ALL|EXISTS|CASE|WHEN|THEN|ELSE|END|WITH)\b/gi,'<span class="sk">$1</span>');r=r.replace(/\b(\d+\.?\d*)\b/g,'<span class="sn">$1</span>');return r}

// ---- Init ----
connectSSE();loadCfg().then(()=>loadModels());setInterval(refreshStats,10000);setTimeout(refreshStats,500);
</script>
</body>
</html>
