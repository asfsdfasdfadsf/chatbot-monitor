<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaWi Chatbot Monitor</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --cyan: #39d2c0;
    --chat-color: #58a6ff;
    --query-color: #bc8cff;
    --error-color: #f85149;
    --system-color: #8b949e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    font-size: 13px;
    height: 100vh;
    overflow: hidden;
  }

  /* Layout */
  .app {
    display: grid;
    grid-template-rows: 42px 1fr;
    height: 100vh;
  }

  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
  }

  .header h1 {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
  }

  .header h1 span { color: var(--accent); }

  .header-stats {
    display: flex;
    gap: 16px;
    margin-left: auto;
    font-size: 12px;
    color: var(--text-dim);
  }

  .header-stats .stat-val { color: var(--text); font-weight: 600; }

  .connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--red);
    transition: background 0.3s;
  }
  .connection-dot.connected { background: var(--green); }

  .panels {
    display: grid;
    grid-template-columns: 300px 1fr 1fr 280px;
    overflow: hidden;
  }

  .panel {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .panel:last-child { border-right: none; }

  .panel-header {
    padding: 8px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .panel-body::-webkit-scrollbar { width: 6px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Feed panel */
  .feed-filters {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  .filter-btn {
    padding: 2px 8px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn:hover { border-color: var(--text-dim); }
  .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .filter-btn.active-red { background: var(--red); color: #fff; border-color: var(--red); }

  .feed-item {
    padding: 8px 10px;
    border-radius: 6px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: background 0.1s;
    border-left: 3px solid transparent;
  }
  .feed-item:hover { background: var(--surface2); }
  .feed-item.selected { background: var(--surface2); border-left-color: var(--accent); }
  .feed-item.flagged { border-left-color: var(--red); }

  .feed-item .feed-type {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 2px;
  }
  .feed-item .feed-type.chat { color: var(--chat-color); }
  .feed-item .feed-type.query { color: var(--query-color); }
  .feed-item .feed-type.error { color: var(--error-color); }
  .feed-item .feed-type.system { color: var(--system-color); }

  .feed-item .feed-preview {
    color: var(--text-dim);
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .feed-item .feed-meta {
    display: flex;
    gap: 8px;
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .feed-item .flag-icon { color: var(--red); }

  /* Chat detail panel */
  .detail-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 13px;
  }

  .chat-bubble {
    padding: 10px 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    max-width: 90%;
    line-height: 1.5;
    font-size: 13px;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .chat-bubble.question {
    background: #1f3a5f;
    border: 1px solid #264a78;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .chat-bubble.answer {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }

  .chat-bubble .bubble-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
    color: var(--text-dim);
  }

  .badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 600;
  }
  .badge-model { background: #1c3a2a; color: var(--green); }
  .badge-time { background: #1a2332; color: var(--accent); }
  .badge-fast { background: #1c3a2a; color: var(--green); }
  .badge-medium { background: #2a2310; color: var(--orange); }
  .badge-slow { background: #2a1515; color: var(--red); }
  .badge-error { background: #2a1515; color: var(--red); }
  .badge-user { background: #1a2332; color: var(--cyan); }

  .detail-meta {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    padding: 0 4px;
  }

  .moderation-bar {
    display: flex;
    gap: 6px;
    padding: 8px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .mod-btn {
    padding: 4px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .mod-btn:hover { border-color: var(--text-dim); color: var(--text); }
  .mod-btn.flag-active { background: #2a1515; border-color: var(--red); color: var(--red); }
  .mod-btn.review-active { background: #1c3a2a; border-color: var(--green); color: var(--green); }

  .note-input {
    flex: 1;
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-size: 11px;
    outline: none;
  }
  .note-input:focus { border-color: var(--accent); }

  /* SQL inspector panel */
  .sql-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .sql-keyword { color: var(--purple); font-weight: 600; }
  .sql-string { color: var(--green); }
  .sql-number { color: var(--orange); }

  .result-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-top: 6px;
  }
  .result-table th {
    background: var(--surface);
    padding: 4px 8px;
    text-align: left;
    border: 1px solid var(--border);
    color: var(--accent);
    font-weight: 600;
    position: sticky;
    top: 0;
  }
  .result-table td {
    padding: 3px 8px;
    border: 1px solid var(--border);
    color: var(--text-dim);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .result-table tr:hover td { background: var(--surface2); }

  .query-error {
    background: #2a1515;
    border: 1px solid var(--red);
    border-radius: 6px;
    padding: 8px 10px;
    color: var(--red);
    font-size: 12px;
    margin-top: 6px;
  }

  /* Stats panel */
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 8px;
  }

  .stat-card .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .stat-card .stat-value {
    font-size: 22px;
    font-weight: 700;
  }

  .stat-card .stat-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
  }

  .stat-grid .stat-card { margin-bottom: 0; }
  .stat-grid .stat-card .stat-value { font-size: 18px; }

  /* Hourly bar chart */
  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 60px;
    padding: 4px 0;
  }

  .bar {
    flex: 1;
    background: var(--accent);
    border-radius: 2px 2px 0 0;
    min-height: 2px;
    position: relative;
    opacity: 0.7;
    transition: opacity 0.15s;
  }
  .bar:hover { opacity: 1; }
  .bar:hover::after {
    content: attr(data-label);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    color: var(--text);
    z-index: 10;
  }

  /* Topics */
  .topic-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .topic-tag {
    padding: 2px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Moderation queue */
  .mod-queue-item {
    padding: 6px 8px;
    border-radius: 6px;
    margin-bottom: 4px;
    cursor: pointer;
    background: var(--surface);
    border: 1px solid var(--border);
    transition: background 0.1s;
  }
  .mod-queue-item:hover { background: var(--surface2); }

  .mod-queue-item .mod-q-type {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .mod-queue-item .mod-q-preview {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Error detail */
  .error-detail {
    background: #1a0f0f;
    border: 1px solid var(--red);
    border-radius: 8px;
    padding: 12px;
  }

  .error-detail .error-type {
    color: var(--red);
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 6px;
  }

  .error-detail .error-msg {
    color: var(--text);
    font-size: 13px;
    line-height: 1.5;
  }

  .error-detail .error-details {
    margin-top: 8px;
    padding: 8px;
    background: var(--surface);
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
    color: var(--text-dim);
    white-space: pre-wrap;
  }

  /* System detail */
  .system-detail {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }

  .system-detail .system-action {
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 6px;
  }

  .section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin: 12px 0 6px;
  }

  /* Responsive - narrow screens */
  @media (max-width: 1200px) {
    .panels {
      grid-template-columns: 250px 1fr 280px;
    }
    .panel.sql-panel { display: none; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <h1><span>WaWi</span> Chatbot Monitor</h1>
    <div class="header-stats" id="headerStats">
      <span>Users: <span class="stat-val" id="hActiveUsers">0</span></span>
      <span>Chats: <span class="stat-val" id="hTotalChats">0</span></span>
      <span>Errors: <span class="stat-val" id="hTotalErrors">0</span></span>
      <span>Avg: <span class="stat-val" id="hAvgResponse">0ms</span></span>
    </div>
    <div class="connection-dot" id="connDot" title="Disconnected"></div>
  </div>

  <!-- Panels -->
  <div class="panels">
    <!-- 1. Live Feed -->
    <div class="panel feed-panel">
      <div class="panel-header">
        Live Feed
        <span id="feedCount" style="margin-left:auto; color:var(--accent);">0</span>
      </div>
      <div class="feed-filters" id="feedFilters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="chat">Chat</button>
        <button class="filter-btn" data-filter="query">SQL</button>
        <button class="filter-btn" data-filter="error">Errors</button>
        <button class="filter-btn" data-filter="flagged">Flagged</button>
      </div>
      <div class="panel-body" id="feedBody"></div>
    </div>

    <!-- 2. Chat Detail -->
    <div class="panel detail-panel">
      <div class="panel-header" id="detailHeader">Detail</div>
      <div class="panel-body" id="detailBody">
        <div class="detail-empty">Select an event from the feed</div>
      </div>
      <div class="moderation-bar" id="modBar" style="display:none;">
        <button class="mod-btn" id="btnFlag" onclick="toggleFlag()">Flag</button>
        <button class="mod-btn" id="btnReview" onclick="toggleReview()">Reviewed</button>
        <input class="note-input" id="noteInput" placeholder="Add note..." onkeydown="if(event.key==='Enter')saveNote()">
        <button class="mod-btn" onclick="saveNote()">Save</button>
      </div>
    </div>

    <!-- 3. SQL Inspector -->
    <div class="panel sql-panel">
      <div class="panel-header">
        SQL Inspector
        <span id="queryCount" style="margin-left:auto; color:var(--query-color);">0</span>
      </div>
      <div class="panel-body" id="sqlBody">
        <div class="detail-empty">SQL queries will appear here</div>
      </div>
    </div>

    <!-- 4. Stats + Moderation -->
    <div class="panel stats-panel">
      <div class="panel-header">Stats &amp; Moderation</div>
      <div class="panel-body" id="statsBody"></div>
    </div>
  </div>
</div>

<script>
// =========================================================================
// State
// =========================================================================
let events = [];
let moderation = {};  // event_id -> {flagged, reviewed, note}
let selectedId = null;
let activeFilter = 'all';
let autoFollow = true;
let connected = false;
let stats = {};

// =========================================================================
// SSE Connection
// =========================================================================
function connectSSE() {
  const es = new EventSource('/api/stream');
  const dot = document.getElementById('connDot');

  es.onopen = () => {
    connected = true;
    dot.className = 'connection-dot connected';
    dot.title = 'Connected';
  };

  es.onerror = () => {
    connected = false;
    dot.className = 'connection-dot';
    dot.title = 'Disconnected - reconnecting...';
  };

  // Initial batch
  es.addEventListener('init', (e) => {
    const data = JSON.parse(e.data);
    events = data;
    renderFeed();
    renderSqlPanel();
    refreshStats();
  });

  // Initial moderation state
  es.addEventListener('moderation', (e) => {
    moderation = JSON.parse(e.data);
    renderFeed();
    if (selectedId) renderDetail(selectedId);
  });

  // Live events
  es.onmessage = (e) => {
    const evt = JSON.parse(e.data);

    // Moderation update
    if (evt.type === '_moderation_update') {
      moderation[evt.event_id] = evt.moderation;
      renderFeed();
      if (selectedId === evt.event_id) renderDetail(selectedId);
      refreshStats();
      return;
    }

    events.push(evt);
    if (events.length > 5000) events.shift();

    addFeedItem(evt);
    if (evt.type === 'query') addSqlItem(evt);
    if (autoFollow && !selectedId) {
      scrollFeedToBottom();
    }
    refreshStats();
  };
}

// =========================================================================
// Feed
// =========================================================================
function renderFeed() {
  const body = document.getElementById('feedBody');
  body.innerHTML = '';
  const filtered = getFilteredEvents();
  document.getElementById('feedCount').textContent = filtered.length;
  filtered.forEach(evt => addFeedItem(evt, false));
  scrollFeedToBottom();
}

function getFilteredEvents() {
  if (activeFilter === 'all') return events.filter(e => e.type !== '_moderation_update');
  if (activeFilter === 'flagged') return events.filter(e => moderation[e.id]?.flagged);
  return events.filter(e => e.type === activeFilter);
}

function addFeedItem(evt, scroll = true) {
  if (evt.type === '_moderation_update') return;
  if (activeFilter !== 'all') {
    if (activeFilter === 'flagged') {
      if (!moderation[evt.id]?.flagged) return;
    } else if (evt.type !== activeFilter) return;
  }

  const body = document.getElementById('feedBody');
  const div = document.createElement('div');
  div.className = 'feed-item' + (evt.id === selectedId ? ' selected' : '') + (moderation[evt.id]?.flagged ? ' flagged' : '');
  div.dataset.id = evt.id;
  div.onclick = () => selectEvent(evt.id);

  const preview = getPreview(evt);
  const time = formatTime(evt.timestamp);
  const flag = moderation[evt.id]?.flagged ? ' <span class="flag-icon">&#9873;</span>' : '';

  div.innerHTML = `
    <div class="feed-type ${evt.type}">${evt.type}${flag}</div>
    <div class="feed-preview">${escHtml(preview)}</div>
    <div class="feed-meta">
      <span>${time}</span>
      ${evt.user_id ? `<span>${escHtml(evt.user_id)}</span>` : ''}
      ${evt.duration_ms ? `<span>${evt.duration_ms}ms</span>` : ''}
    </div>
  `;

  body.appendChild(div);
  document.getElementById('feedCount').textContent = body.children.length;
  if (scroll) scrollFeedToBottom();
}

function getPreview(evt) {
  switch (evt.type) {
    case 'chat': return evt.question || '';
    case 'query': return evt.sql || '';
    case 'error': return evt.message || '';
    case 'system': return `[${evt.action || ''}] ${evt.message || ''}`;
    default: return JSON.stringify(evt).slice(0, 80);
  }
}

function scrollFeedToBottom() {
  const body = document.getElementById('feedBody');
  body.scrollTop = body.scrollHeight;
}

// =========================================================================
// Filters
// =========================================================================
document.getElementById('feedFilters').addEventListener('click', (e) => {
  if (!e.target.classList.contains('filter-btn')) return;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'active-red'));
  const filter = e.target.dataset.filter;
  e.target.classList.add(filter === 'flagged' ? 'active-red' : 'active');
  activeFilter = filter;
  renderFeed();
});

// =========================================================================
// Detail panel
// =========================================================================
function selectEvent(id) {
  selectedId = id;
  autoFollow = false;

  // Highlight feed item
  document.querySelectorAll('.feed-item').forEach(el => {
    el.classList.toggle('selected', el.dataset.id === id);
  });

  renderDetail(id);
}

function renderDetail(id) {
  const evt = events.find(e => e.id === id);
  if (!evt) return;

  const header = document.getElementById('detailHeader');
  const body = document.getElementById('detailBody');
  const modBar = document.getElementById('modBar');

  header.textContent = evt.type.toUpperCase() + ' Detail';
  modBar.style.display = 'flex';

  // Update moderation buttons
  const mod = moderation[id] || {};
  document.getElementById('btnFlag').className = 'mod-btn' + (mod.flagged ? ' flag-active' : '');
  document.getElementById('btnFlag').textContent = mod.flagged ? 'Unflag' : 'Flag';
  document.getElementById('btnReview').className = 'mod-btn' + (mod.reviewed ? ' review-active' : '');
  document.getElementById('btnReview').textContent = mod.reviewed ? 'Reviewed âœ“' : 'Mark Reviewed';
  document.getElementById('noteInput').value = mod.note || '';

  switch (evt.type) {
    case 'chat': return renderChatDetail(body, evt);
    case 'query': return renderQueryDetail(body, evt);
    case 'error': return renderErrorDetail(body, evt);
    case 'system': return renderSystemDetail(body, evt);
    default: body.innerHTML = `<pre style="color:var(--text-dim)">${escHtml(JSON.stringify(evt, null, 2))}</pre>`;
  }
}

function renderChatDetail(body, evt) {
  const timeBadge = getTimeBadge(evt.duration_ms);
  body.innerHTML = `
    <div class="detail-meta">
      ${evt.model ? `<span class="badge badge-model">${escHtml(evt.model)}</span>` : ''}
      ${evt.duration_ms ? `<span class="badge ${timeBadge.cls}">${evt.duration_ms}ms</span>` : ''}
      ${evt.user_id ? `<span class="badge badge-user">${escHtml(evt.user_id)}</span>` : ''}
      <span class="badge badge-time">${formatTime(evt.timestamp)}</span>
    </div>
    <div class="chat-bubble question">
      <div class="bubble-label">User</div>
      ${escHtml(evt.question || '')}
    </div>
    <div class="chat-bubble answer">
      <div class="bubble-label">Bot</div>
      ${escHtml(evt.answer || '')}
    </div>
    ${evt.metadata ? `<div class="section-title">Metadata</div><pre style="color:var(--text-dim);font-size:11px">${escHtml(JSON.stringify(evt.metadata, null, 2))}</pre>` : ''}
  `;
}

function renderQueryDetail(body, evt) {
  const timeBadge = getTimeBadge(evt.duration_ms);
  let html = `
    <div class="detail-meta">
      ${evt.duration_ms != null ? `<span class="badge ${timeBadge.cls}">${evt.duration_ms}ms</span>` : ''}
      ${evt.user_id ? `<span class="badge badge-user">${escHtml(evt.user_id)}</span>` : ''}
      <span class="badge badge-time">${formatTime(evt.timestamp)}</span>
    </div>
    <div class="sql-block">${highlightSQL(evt.sql || '')}</div>
  `;

  if (evt.error) {
    html += `<div class="query-error">${escHtml(evt.error)}</div>`;
  }

  if (evt.results && Array.isArray(evt.results) && evt.results.length > 0) {
    html += renderResultTable(evt.results);
    if (evt.results_truncated) {
      html += `<div style="font-size:11px;color:var(--orange);margin-top:4px">Showing ${evt.results.length} of ${evt.results_total} rows (truncated)</div>`;
    }
  }

  body.innerHTML = html;
}

function renderErrorDetail(body, evt) {
  body.innerHTML = `
    <div class="detail-meta">
      <span class="badge badge-error">${escHtml(evt.error_type || 'error')}</span>
      ${evt.user_id ? `<span class="badge badge-user">${escHtml(evt.user_id)}</span>` : ''}
      <span class="badge badge-time">${formatTime(evt.timestamp)}</span>
    </div>
    <div class="error-detail">
      <div class="error-type">${escHtml(evt.error_type || 'Error')}</div>
      <div class="error-msg">${escHtml(evt.message || '')}</div>
      ${evt.details ? `<div class="error-details">${escHtml(evt.details)}</div>` : ''}
    </div>
    ${evt.metadata ? `<div class="section-title">Metadata</div><pre style="color:var(--text-dim);font-size:11px">${escHtml(JSON.stringify(evt.metadata, null, 2))}</pre>` : ''}
  `;
}

function renderSystemDetail(body, evt) {
  body.innerHTML = `
    <div class="detail-meta">
      <span class="badge badge-time">${formatTime(evt.timestamp)}</span>
    </div>
    <div class="system-detail">
      <div class="system-action">${escHtml(evt.action || 'system')}</div>
      <div style="color:var(--text-dim);margin-top:4px">${escHtml(evt.message || '')}</div>
    </div>
    ${evt.metadata ? `<div class="section-title">Metadata</div><pre style="color:var(--text-dim);font-size:11px">${escHtml(JSON.stringify(evt.metadata, null, 2))}</pre>` : ''}
  `;
}

// =========================================================================
// SQL Inspector Panel
// =========================================================================
function renderSqlPanel() {
  const body = document.getElementById('sqlBody');
  const queries = events.filter(e => e.type === 'query');
  document.getElementById('queryCount').textContent = queries.length;

  if (queries.length === 0) {
    body.innerHTML = '<div class="detail-empty">SQL queries will appear here</div>';
    return;
  }

  body.innerHTML = '';
  queries.slice(-50).forEach(evt => addSqlItem(evt, false));
  body.scrollTop = body.scrollHeight;
}

function addSqlItem(evt, scroll = true) {
  const body = document.getElementById('sqlBody');
  if (body.querySelector('.detail-empty')) body.innerHTML = '';

  const div = document.createElement('div');
  div.style.marginBottom = '10px';

  const timeBadge = getTimeBadge(evt.duration_ms);
  let html = `
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
      ${evt.duration_ms != null ? `<span class="badge ${timeBadge.cls}">${evt.duration_ms}ms</span>` : ''}
      ${evt.user_id ? `<span class="badge badge-user">${escHtml(evt.user_id)}</span>` : ''}
      <span style="font-size:10px;color:var(--text-dim)">${formatTime(evt.timestamp)}</span>
    </div>
    <div class="sql-block" style="cursor:pointer" onclick="selectEvent('${evt.id}')">${highlightSQL(evt.sql || '')}</div>
  `;

  if (evt.error) {
    html += `<div class="query-error">${escHtml(evt.error)}</div>`;
  } else if (evt.results && Array.isArray(evt.results) && evt.results.length > 0) {
    html += renderResultTable(evt.results);
  }

  div.innerHTML = html;
  body.appendChild(div);

  document.getElementById('queryCount').textContent = events.filter(e => e.type === 'query').length;
  if (scroll) body.scrollTop = body.scrollHeight;
}

function renderResultTable(rows) {
  if (!rows.length) return '';
  const cols = Object.keys(rows[0]);
  let html = '<div style="overflow-x:auto"><table class="result-table"><thead><tr>';
  cols.forEach(c => html += `<th>${escHtml(String(c))}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(row => {
    html += '<tr>';
    cols.forEach(c => html += `<td title="${escHtml(String(row[c] ?? ''))}">${escHtml(String(row[c] ?? ''))}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  return html;
}

// =========================================================================
// Stats Panel
// =========================================================================
function refreshStats() {
  fetch('/api/stats')
    .then(r => r.json())
    .then(s => {
      stats = s;
      renderStats(s);
      // Update header
      document.getElementById('hActiveUsers').textContent = s.active_users;
      document.getElementById('hTotalChats').textContent = s.total_chats;
      document.getElementById('hTotalErrors').textContent = s.total_errors;
      document.getElementById('hAvgResponse').textContent = s.avg_response_ms + 'ms';
    })
    .catch(() => {});
}

function renderStats(s) {
  const body = document.getElementById('statsBody');
  body.innerHTML = `
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">Active Users</div>
        <div class="stat-value" style="color:var(--cyan)">${s.active_users}</div>
        <div class="stat-sub">last hour</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Response</div>
        <div class="stat-value" style="color:${s.avg_response_ms > 5000 ? 'var(--red)' : s.avg_response_ms > 2000 ? 'var(--orange)' : 'var(--green)'}">${formatDuration(s.avg_response_ms)}</div>
        <div class="stat-sub">per chat</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Error Rate</div>
        <div class="stat-value" style="color:${s.error_rate > 5 ? 'var(--red)' : s.error_rate > 1 ? 'var(--orange)' : 'var(--green)'}">${s.error_rate}%</div>
        <div class="stat-sub">${s.total_errors} total</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Msgs/Hour</div>
        <div class="stat-value" style="color:var(--accent)">${s.messages_last_hour}</div>
        <div class="stat-sub">${s.total_chats} total</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Avg Query Time</div>
      <div style="display:flex;align-items:baseline;gap:6px">
        <span style="font-size:18px;font-weight:700;color:${s.avg_query_ms > 500 ? 'var(--red)' : s.avg_query_ms > 100 ? 'var(--orange)' : 'var(--green)'}">${formatDuration(s.avg_query_ms)}</span>
        <span style="font-size:11px;color:var(--text-dim)">${s.total_queries} queries</span>
      </div>
    </div>

    <div class="section-title">Hourly Chat Volume (24h)</div>
    <div class="stat-card" style="padding:8px">
      ${renderBarChart(s.hourly || {})}
    </div>

    <div class="section-title">Event Types</div>
    <div class="stat-card" style="padding:8px">
      ${renderTypeBreakdown(s.type_counts || {})}
    </div>

    <div class="section-title">Top Topics</div>
    <div class="topic-list" style="margin-bottom:12px">
      ${(s.topics || []).map(t => `<span class="topic-tag">${escHtml(t)}</span>`).join('')}
      ${(s.topics || []).length === 0 ? '<span style="color:var(--text-dim);font-size:11px">No topics yet</span>' : ''}
    </div>

    <div class="section-title">Moderation Queue</div>
    <div class="stat-card">
      <div style="display:flex;gap:16px;font-size:12px">
        <span style="color:var(--red)">Flagged: ${s.flagged || 0}</span>
        <span style="color:var(--orange)">Unreviewed: ${s.unreviewed || 0}</span>
        <span style="color:var(--green)">Reviewed: ${s.reviewed || 0}</span>
      </div>
    </div>
    <div id="modQueue"></div>
  `;

  // Render moderation queue items
  renderModQueue();
}

function renderBarChart(hourly) {
  const entries = Object.entries(hourly);
  if (entries.length === 0) return '<div style="color:var(--text-dim);font-size:11px;text-align:center;padding:10px">No data yet</div>';

  const max = Math.max(...entries.map(e => e[1]), 1);
  let html = '<div class="bar-chart">';
  entries.forEach(([hour, count]) => {
    const pct = (count / max * 100);
    html += `<div class="bar" style="height:${Math.max(pct, 3)}%" data-label="${hour}: ${count}"></div>`;
  });
  html += '</div>';
  html += `<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);padding:0 2px">`;
  if (entries.length > 0) {
    html += `<span>${entries[0][0]}</span>`;
    if (entries.length > 1) html += `<span>${entries[entries.length-1][0]}</span>`;
  }
  html += '</div>';
  return html;
}

function renderTypeBreakdown(counts) {
  const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
  const colors = { chat: 'var(--chat-color)', query: 'var(--query-color)', error: 'var(--error-color)', system: 'var(--system-color)' };
  let html = '<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-bottom:6px">';
  Object.entries(counts).forEach(([type, count]) => {
    const pct = count / total * 100;
    if (pct > 0) {
      html += `<div style="width:${pct}%;background:${colors[type] || 'var(--text-dim)'}" title="${type}: ${count}"></div>`;
    }
  });
  html += '</div><div style="display:flex;gap:12px;flex-wrap:wrap">';
  Object.entries(counts).forEach(([type, count]) => {
    html += `<span style="font-size:11px;color:${colors[type] || 'var(--text-dim)'}">${type}: ${count}</span>`;
  });
  html += '</div>';
  return html;
}

function renderModQueue() {
  const container = document.getElementById('modQueue');
  if (!container) return;

  const flaggedEvents = events.filter(e => moderation[e.id]?.flagged && !moderation[e.id]?.reviewed);
  if (flaggedEvents.length === 0) {
    container.innerHTML = '<div style="font-size:11px;color:var(--text-dim);padding:4px 8px">No items in queue</div>';
    return;
  }

  container.innerHTML = flaggedEvents.slice(-20).reverse().map(evt => `
    <div class="mod-queue-item" onclick="selectEvent('${evt.id}')">
      <div class="mod-q-type" style="color:var(--${evt.type}-color)">${evt.type}</div>
      <div class="mod-q-preview">${escHtml(getPreview(evt))}</div>
    </div>
  `).join('');
}

// =========================================================================
// Moderation
// =========================================================================
function toggleFlag() {
  if (!selectedId) return;
  const current = moderation[selectedId]?.flagged || false;
  postModeration(selectedId, { flagged: !current });
}

function toggleReview() {
  if (!selectedId) return;
  const current = moderation[selectedId]?.reviewed || false;
  postModeration(selectedId, { reviewed: !current });
}

function saveNote() {
  if (!selectedId) return;
  const note = document.getElementById('noteInput').value;
  postModeration(selectedId, { note });
}

function postModeration(eventId, data) {
  fetch(`/api/moderate/${eventId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  }).catch(() => {});
}

// =========================================================================
// Helpers
// =========================================================================
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts * 1000);
  return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function formatDuration(ms) {
  if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
  return Math.round(ms) + 'ms';
}

function getTimeBadge(ms) {
  if (!ms) return { cls: 'badge-time' };
  if (ms < 100) return { cls: 'badge-fast' };
  if (ms < 500) return { cls: 'badge-medium' };
  return { cls: 'badge-slow' };
}

function highlightSQL(sql) {
  const keywords = /\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|IN|IS|NULL|AS|ORDER BY|GROUP BY|HAVING|LIMIT|OFFSET|INSERT|INTO|VALUES|UPDATE|SET|DELETE|CREATE|ALTER|DROP|TABLE|INDEX|COUNT|SUM|AVG|MIN|MAX|DISTINCT|BETWEEN|LIKE|UNION|ALL|EXISTS|CASE|WHEN|THEN|ELSE|END|WITH|RECURSIVE)\b/gi;
  const strings = /('[^']*')/g;
  const numbers = /\b(\d+\.?\d*)\b/g;

  let result = escHtml(sql);
  result = result.replace(strings, '<span class="sql-string">$1</span>');
  result = result.replace(keywords, '<span class="sql-keyword">$1</span>');
  result = result.replace(numbers, (m) => {
    // Don't highlight numbers inside already-highlighted spans
    return `<span class="sql-number">${m}</span>`;
  });
  return result;
}

// =========================================================================
// Init
// =========================================================================
connectSSE();
setInterval(refreshStats, 10000);
setTimeout(refreshStats, 500);
</script>
</body>
</html>
