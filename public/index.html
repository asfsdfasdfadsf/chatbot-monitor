<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaWi Chatbot Monitor</title>
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --surface2: #1c2333;
  --border: #30363d; --text: #e6edf3; --text-dim: #8b949e;
  --accent: #58a6ff; --green: #3fb950; --orange: #d29922;
  --red: #f85149; --purple: #bc8cff; --cyan: #39d2c0;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif; font-size:13px; height:100vh; overflow:hidden; }
.app { display:grid; grid-template-rows:42px 1fr; height:100vh; }

/* Header */
.header { background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 16px; gap:12px; }
.header h1 { font-size:14px; font-weight:600; white-space:nowrap; }
.header h1 span { color:var(--accent); }
.header-stats { display:flex; gap:14px; margin-left:auto; font-size:12px; color:var(--text-dim); }
.header-stats .sv { color:var(--text); font-weight:600; }
.hbtn { padding:3px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.hbtn:hover { border-color:var(--text-dim); color:var(--text); }
.hbtn.danger:hover { border-color:var(--red); color:var(--red); }
.cdot { width:8px; height:8px; border-radius:50%; background:var(--red); transition:background .3s; }
.cdot.on { background:var(--green); }

/* 3-panel layout */
.panels { display:grid; grid-template-columns:280px 1fr 300px; overflow:hidden; }
.panel { border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
.panel:last-child { border-right:none; }
.panel-hdr { padding:8px 12px; background:var(--surface); border-bottom:1px solid var(--border); font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); display:flex; align-items:center; gap:8px; flex-shrink:0; }
.panel-body { flex:1; overflow-y:auto; padding:8px; }
.panel-body::-webkit-scrollbar { width:6px; }
.panel-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* Tabs */
.tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; background:var(--surface); }
.tab { padding:6px 14px; border:none; background:transparent; color:var(--text-dim); font-size:12px; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; position:relative; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.tab .tbadge { position:absolute; top:2px; right:4px; background:var(--accent); color:#fff; font-size:9px; padding:0 4px; border-radius:6px; min-width:14px; text-align:center; }
.tab .tbadge.red { background:var(--red); }
.tab .tbadge.hide { display:none; }

/* Feed */
.ffilters { display:flex; gap:4px; padding:6px 8px; border-bottom:1px solid var(--border); flex-wrap:wrap; flex-shrink:0; }
.fbtn { padding:2px 8px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.fbtn:hover { border-color:var(--text-dim); }
.fbtn.on { background:var(--accent); color:#fff; border-color:var(--accent); }
.fbtn.on-red { background:var(--red); color:#fff; border-color:var(--red); }
.fi { padding:8px 10px; border-radius:6px; margin-bottom:4px; cursor:pointer; transition:background .1s; border-left:3px solid transparent; }
.fi:hover { background:var(--surface2); }
.fi.sel { background:var(--surface2); border-left-color:var(--accent); }
.fi.flagged { border-left-color:var(--red); }
.fi .ft { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.3px; margin-bottom:2px; }
.fi .ft.chat { color:var(--accent); } .fi .ft.query { color:var(--purple); }
.fi .ft.error { color:var(--red); } .fi .ft.system { color:var(--text-dim); }
.fi .fp { color:var(--text-dim); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.fi .fm { display:flex; gap:8px; font-size:10px; color:var(--text-dim); margin-top:2px; }

/* Chat */
.cmsg { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }
.cmsg::-webkit-scrollbar { width:6px; } .cmsg::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.cempty { display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-dim); font-size:13px; flex-direction:column; gap:8px; }
.bubble { padding:10px 14px; border-radius:12px; max-width:85%; line-height:1.5; font-size:13px; word-wrap:break-word; white-space:pre-wrap; }
.bubble.q { background:#1f3a5f; border:1px solid #264a78; align-self:flex-end; border-bottom-right-radius:4px; }
.bubble.a { background:var(--surface2); border:1px solid var(--border); align-self:flex-start; border-bottom-left-radius:4px; }
.bubble .bl { font-size:10px; font-weight:600; text-transform:uppercase; margin-bottom:4px; color:var(--text-dim); }
.bubble .bm { font-size:10px; color:var(--text-dim); margin-top:4px; display:flex; gap:8px; }
.cinput { padding:10px; border-top:1px solid var(--border); background:var(--surface); flex-shrink:0; }
.crow { display:flex; gap:6px; align-items:flex-end; }
.cin { flex:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; font-family:inherit; outline:none; resize:none; min-height:38px; max-height:120px; }
.cin:focus { border-color:var(--accent); }
.cin::placeholder { color:var(--text-dim); }
.csend { padding:8px 16px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-size:13px; font-weight:600; cursor:pointer; min-height:38px; transition:opacity .15s; }
.csend:hover { opacity:.85; } .csend:disabled { opacity:.4; cursor:not-allowed; }
.ccfg { display:flex; gap:8px; margin-top:6px; align-items:center; }
.ccfg select,.ccfg input { padding:3px 8px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:11px; outline:none; }
.ccfg label { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; }
.cthink { align-self:flex-start; padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:12px; border-bottom-left-radius:4px; color:var(--text-dim); }
.dots { display:inline-flex; gap:4px; }
.dots span { width:6px; height:6px; border-radius:50%; background:var(--text-dim); animation:pulse 1.4s infinite both; }
.dots span:nth-child(2) { animation-delay:.2s; } .dots span:nth-child(3) { animation-delay:.4s; }
@keyframes pulse { 0%,80%,100%{opacity:.3;transform:scale(.8)} 40%{opacity:1;transform:scale(1)} }
.drop-overlay { display:none;position:absolute;inset:0;background:rgba(88,166,255,.08);border:2px dashed var(--accent);border-radius:8px;z-index:50;align-items:center;justify-content:center;pointer-events:none; }
.drop-overlay.active { display:flex; }
.drop-overlay span { background:var(--surface);padding:8px 18px;border-radius:8px;font-size:13px;color:var(--accent);font-weight:600;border:1px solid var(--accent); }
.stream-cursor { color:var(--accent); animation:blink 1s step-end infinite; }
@keyframes blink { 50%{opacity:0} }

/* Detail */
.dempty { display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-dim); }
.badge { display:inline-block; padding:1px 6px; border-radius:8px; font-size:10px; font-weight:600; }
.bmod { background:#1c3a2a; color:var(--green); } .btime { background:#1a2332; color:var(--accent); }
.bfast { background:#1c3a2a; color:var(--green); } .bmed { background:#2a2310; color:var(--orange); }
.bslow { background:#2a1515; color:var(--red); } .berr { background:#2a1515; color:var(--red); }
.buser { background:#1a2332; color:var(--cyan); }
.dmeta { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; padding:0 4px; }
.mbar { display:flex; gap:6px; padding:8px; border-top:1px solid var(--border); flex-shrink:0; }
.mbtn { padding:4px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:11px; cursor:pointer; transition:all .15s; }
.mbtn:hover { border-color:var(--text-dim); color:var(--text); }
.mbtn.fon { background:#2a1515; border-color:var(--red); color:var(--red); }
.mbtn.ron { background:#1c3a2a; border-color:var(--green); color:var(--green); }
.nin { flex:1; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:11px; outline:none; }
.nin:focus { border-color:var(--accent); }

/* SQL */
.sqlb { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:8px; font-family:'Cascadia Code','Fira Code',Consolas,monospace; font-size:12px; white-space:pre-wrap; word-break:break-all; }
.sk { color:var(--purple); font-weight:600; } .ss { color:var(--green); } .sn { color:var(--orange); }
.rtbl { width:100%; border-collapse:collapse; font-size:11px; margin-top:6px; }
.rtbl th { background:var(--surface); padding:4px 8px; text-align:left; border:1px solid var(--border); color:var(--accent); font-weight:600; }
.rtbl td { padding:3px 8px; border:1px solid var(--border); color:var(--text-dim); max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.rtbl tr:hover td { background:var(--surface2); }
.qerr { background:#2a1515; border:1px solid var(--red); border-radius:6px; padding:8px 10px; color:var(--red); font-size:12px; margin-top:6px; }

/* Users panel */
.uitem { padding:8px 10px; border-radius:6px; margin-bottom:4px; cursor:pointer; transition:background .1s; display:flex; align-items:center; gap:8px; }
.uitem:hover { background:var(--surface2); }
.uitem.sel { background:var(--surface2); }
.udot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.udot.active { background:var(--green); } .udot.blocked { background:var(--red); } .udot.restricted { background:var(--orange); }
.uinfo { flex:1; min-width:0; }
.uname { font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.umeta { font-size:10px; color:var(--text-dim); }
.ustatus { font-size:10px; font-weight:600; padding:1px 6px; border-radius:6px; }
.ustatus.active { background:#1c3a2a; color:var(--green); }
.ustatus.blocked { background:#2a1515; color:var(--red); }
.ustatus.restricted { background:#2a2310; color:var(--orange); }

/* User detail */
.udetail { padding:8px; }
.ucard { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px; }
.ucard h3 { font-size:14px; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.ucard .ustat-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.ucard .ustat-item { font-size:11px; color:var(--text-dim); }
.ucard .ustat-item strong { color:var(--text); }
.ubtn { padding:6px 14px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:12px; cursor:pointer; transition:all .15s; font-weight:600; }
.ubtn:hover { color:var(--text); border-color:var(--text-dim); }
.ubtn.block { color:var(--red); border-color:var(--red); }
.ubtn.block:hover { background:#2a1515; }
.ubtn.unblock { color:var(--green); border-color:var(--green); }
.ubtn.unblock:hover { background:#1c3a2a; }
.uevt { padding:6px 8px; border-radius:6px; margin-bottom:3px; background:var(--surface); border:1px solid var(--border); font-size:11px; cursor:pointer; }
.uevt:hover { background:var(--surface2); }

/* Stats */
.sc { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 12px; margin-bottom:8px; }
.sc .sl { font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); margin-bottom:4px; }
.sc .sv { font-size:22px; font-weight:700; }
.sc .ssub { font-size:11px; color:var(--text-dim); margin-top:2px; }
.sgrid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px; }
.sgrid .sc { margin-bottom:0; } .sgrid .sc .sv { font-size:18px; }
.barchart { display:flex; align-items:flex-end; gap:2px; height:60px; padding:4px 0; }
.bar { flex:1; background:var(--accent); border-radius:2px 2px 0 0; min-height:2px; position:relative; opacity:.7; transition:opacity .15s; }
.bar:hover { opacity:1; }
.bar:hover::after { content:attr(data-label); position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background:var(--surface); border:1px solid var(--border); padding:2px 6px; border-radius:4px; font-size:10px; white-space:nowrap; color:var(--text); z-index:10; }
.tlist { display:flex; flex-wrap:wrap; gap:4px; }
.ttag { padding:2px 8px; background:var(--surface2); border:1px solid var(--border); border-radius:10px; font-size:11px; color:var(--text-dim); }
.stitle { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; color:var(--text-dim); margin:12px 0 6px; }
.edetail { background:#1a0f0f; border:1px solid var(--red); border-radius:8px; padding:12px; }
.sysdetail { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:12px; }

/* Settings modal */
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:100; align-items:center; justify-content:center; }
.modal.open { display:flex; }
.mbox { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; width:460px; max-width:90vw; max-height:85vh; overflow-y:auto; }
.mbox h2 { font-size:15px; margin-bottom:14px; }
.mf { margin-bottom:12px; }
.mf label { display:block; font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; margin-bottom:4px; }
.mf input,.mf textarea,.mf select { width:100%; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:12px; font-family:inherit; outline:none; }
.mf textarea { min-height:60px; resize:vertical; }
.mf input:focus,.mf textarea:focus { border-color:var(--accent); }
.mactions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
.mactions button { padding:6px 16px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text-dim); font-size:12px; cursor:pointer; transition:all .15s; }
.mactions button:hover { color:var(--text); border-color:var(--text-dim); }
.mactions button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }

@media (max-width:1100px) { .panels { grid-template-columns:240px 1fr 260px; } }

/* Login Screen */
.login-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:200; display:flex; align-items:center; justify-content:center; }
.login-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:32px; width:360px; max-width:90vw; }
.login-card h2 { font-size:18px; margin-bottom:4px; text-align:center; }
.login-card h2 span { color:var(--accent); }
.login-card .login-sub { font-size:12px; color:var(--text-dim); text-align:center; margin-bottom:20px; }
.login-tabs { display:flex; margin-bottom:16px; border-bottom:1px solid var(--border); }
.login-tab { flex:1; padding:8px; border:none; background:transparent; color:var(--text-dim); font-size:13px; cursor:pointer; border-bottom:2px solid transparent; transition:all .15s; }
.login-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.login-field { margin-bottom:12px; }
.login-field input { width:100%; padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:13px; font-family:inherit; outline:none; box-sizing:border-box; }
.login-field input:focus { border-color:var(--accent); }
.login-btn { width:100%; padding:10px; border-radius:6px; border:none; background:var(--accent); color:#fff; font-size:14px; font-weight:600; cursor:pointer; transition:opacity .15s; }
.login-btn:hover { opacity:.85; }
.login-btn:disabled { opacity:.4; cursor:not-allowed; }
.login-error { color:var(--red); font-size:12px; text-align:center; margin-top:8px; min-height:18px; }
.role-badge { font-size:10px; font-weight:600; padding:1px 6px; border-radius:6px; text-transform:uppercase; }
.role-badge.admin { background:rgba(248,81,73,0.15); color:var(--red); }
.role-badge.mitarbeiter { background:rgba(57,210,192,0.15); color:var(--cyan); }
.role-badge.user { background:rgba(88,166,255,0.15); color:var(--accent); }
.user-header-info { display:flex; align-items:center; gap:6px; margin-left:8px; }

/* Token usage meter */
.usage-bar { display:none; padding:6px 12px; background:var(--surface); border-top:1px solid var(--border); font-size:11px; color:var(--text-dim); }
.usage-bar.visible { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.usage-bar .ub-item { display:flex; align-items:center; gap:4px; }
.usage-bar .ub-label { color:var(--text-dim); }
.usage-bar .ub-val { color:var(--text); font-weight:600; font-variant-numeric:tabular-nums; }
.usage-bar .ub-val.accent { color:var(--accent); }
.usage-bar .ub-sep { width:1px; height:14px; background:var(--border); }
.usage-bar .ub-msg { display:flex; align-items:center; gap:3px; }
.usage-bar .ub-dot { width:6px; height:6px; border-radius:50%; }
.usage-bar .ub-dot.in { background:var(--cyan); }
.usage-bar .ub-dot.out { background:var(--green); }

/* Tool log in chat bubbles */
.tool-log { margin-top:8px; border-top:1px solid var(--border); padding-top:6px; }
.tool-log-header { cursor:pointer; font-size:11px; color:var(--text-dim); display:flex; align-items:center; gap:4px; user-select:none; }
.tool-log-header:hover { color:var(--text); }
.tool-log .toggle-arrow { font-size:9px; transition:transform .2s; }
.tool-log.open .toggle-arrow { transform:rotate(90deg); }
.tool-log-body { display:none; margin-top:6px; }
.tool-log.open .tool-log-body { display:block; }
.tool-step { margin-bottom:6px; padding:4px 8px; background:var(--surface); border:1px solid var(--border); border-radius:6px; font-size:11px; }
.tool-step .tool-name { font-weight:600; padding:1px 6px; border-radius:4px; font-size:10px; }
.tool-name.tn-query_database, .tool-name.tn-list_tables { background:#1a2332; color:var(--accent); }
.tool-name.tn-search_knowledge { background:#1f1a33; color:var(--purple); }
.tool-name.tn-web_search { background:#1a2e1a; color:var(--green); }
.tool-name.tn-search_emails, .tool-name.tn-read_email { background:#1a2e2e; color:var(--cyan); }
.tool-name.tn-calculate { background:#2a2310; color:var(--orange); }
.tool-name.tn-get_datetime { background:#1c1c1c; color:var(--text-dim); }
.tool-step pre { margin:3px 0 0; padding:4px 6px; background:var(--bg); border-radius:4px; font-size:10px; white-space:pre-wrap; word-break:break-all; max-height:80px; overflow-y:auto; color:var(--text-dim); font-family:'Cascadia Code','Fira Code',Consolas,monospace; }
.agent-badge { display:inline-block; padding:1px 5px; border-radius:4px; font-size:9px; font-weight:700; background:rgba(188,140,255,0.15); color:var(--purple); margin-left:4px; text-transform:uppercase; letter-spacing:.3px; vertical-align:middle; }

/* Agent Viewer Panel */
.agent-panel { position:fixed; top:0; right:0; width:440px; height:100vh; background:var(--bg); border-left:1px solid var(--border); z-index:100; display:flex; flex-direction:column; transform:translateX(100%); transition:transform .3s ease; box-shadow:-4px 0 24px rgba(0,0,0,.4); }
.agent-panel.open { transform:translateX(0); }
.ap-header { padding:10px 14px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; flex-shrink:0; }
.ap-header .ap-title { font-size:13px; font-weight:600; flex:1; }
.ap-header .ap-status { font-size:11px; padding:2px 8px; border-radius:10px; }
.ap-status.running { background:rgba(88,166,255,.15); color:var(--accent); }
.ap-status.thinking { background:rgba(188,140,255,.15); color:var(--purple); }
.ap-status.done { background:rgba(63,185,80,.15); color:var(--green); }
.ap-status.error { background:rgba(248,81,73,.15); color:var(--red); }
.ap-close { background:none; border:1px solid var(--border); color:var(--text-dim); width:26px; height:26px; border-radius:6px; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.ap-close:hover { border-color:var(--text-dim); color:var(--text); }
.ap-body { flex:1; display:flex; overflow:hidden; }
.ap-timeline { width:140px; border-right:1px solid var(--border); overflow-y:auto; flex-shrink:0; padding:6px; }
.ap-timeline::-webkit-scrollbar { width:4px; }
.ap-timeline::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
.ap-titem { padding:6px 8px; border-radius:6px; margin-bottom:4px; cursor:pointer; border:1px solid transparent; transition:all .15s; position:relative; }
.ap-titem:hover { background:var(--surface2); }
.ap-titem.active { background:var(--surface2); border-color:var(--accent); }
.ap-titem .ap-tn { font-size:10px; font-weight:600; margin-bottom:2px; display:flex; align-items:center; gap:4px; }
.ap-titem .ap-td { font-size:9px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ap-titem .ap-tms { font-size:9px; color:var(--text-dim); margin-top:1px; }
.ap-tc-db { color:var(--accent); }
.ap-tc-web { color:var(--green); }
.ap-tc-rag { color:var(--purple); }
.ap-tc-calc { color:var(--orange); }
.ap-tc-time { color:var(--cyan); }
.ap-tc-think { color:var(--text-dim); }
.ap-tc-done { color:var(--green); }
.ap-tc-email { color:var(--cyan); }
.ap-tc-generic { color:var(--text); }
.ap-viewer { flex:1; overflow-y:auto; padding:12px; }
.ap-viewer::-webkit-scrollbar { width:5px; }
.ap-viewer::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* Thinking orb */
.apv-thinking { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:16px; }
.apv-orb { width:80px; height:80px; border-radius:50%; background:radial-gradient(circle at 35% 35%, var(--purple), var(--accent)); animation:apv-pulse 2s ease-in-out infinite; box-shadow:0 0 30px rgba(188,140,255,.3); }
@keyframes apv-pulse { 0%,100%{transform:scale(1);opacity:.8} 50%{transform:scale(1.12);opacity:1} }
.apv-orb-label { font-size:12px; color:var(--text-dim); }

/* DB viewer */
.apv-db { font-family:'Cascadia Code','Fira Code',Consolas,monospace; }
.apv-db .apv-titlebar { display:flex; align-items:center; gap:6px; padding:6px 10px; background:#2d2d2d; border-radius:8px 8px 0 0; }
.apv-db .apv-dot { width:10px; height:10px; border-radius:50%; }
.apv-db .apv-dot.r { background:#ff5f57; }
.apv-db .apv-dot.y { background:#febc2e; }
.apv-db .apv-dot.g { background:#28c840; }
.apv-db .apv-db-title { font-size:11px; color:#999; margin-left:6px; }
.apv-db .apv-sql { padding:10px 12px; background:#1a1a2e; font-size:12px; color:#c792ea; white-space:pre-wrap; word-break:break-all; line-height:1.5; }
.apv-db .apv-sql .kw { color:#c792ea; font-weight:600; }
.apv-db .apv-result { padding:10px 12px; background:#0d1117; border-radius:0 0 8px 8px; font-size:11px; color:var(--text); overflow-x:auto; }
.apv-db .apv-result table { width:100%; border-collapse:collapse; }
.apv-db .apv-result th { text-align:left; padding:3px 8px; border-bottom:1px solid var(--border); color:var(--accent); font-size:10px; font-weight:600; }
.apv-db .apv-result td { padding:3px 8px; border-bottom:1px solid rgba(48,54,61,.4); font-size:10px; color:var(--text-dim); }

/* Browser/WebSearch viewer */
.apv-browser { border-radius:8px; overflow:hidden; border:1px solid var(--border); }
.apv-browser .apv-bar { display:flex; align-items:center; gap:6px; padding:6px 10px; background:#292d33; }
.apv-browser .apv-bar-dots { display:flex; gap:4px; }
.apv-browser .apv-bar-dots span { width:10px; height:10px; border-radius:50%; }
.apv-browser .apv-bar-dots span:nth-child(1) { background:#ff5f57; }
.apv-browser .apv-bar-dots span:nth-child(2) { background:#febc2e; }
.apv-browser .apv-bar-dots span:nth-child(3) { background:#28c840; }
.apv-browser .apv-url { flex:1; background:#1a1d23; border:1px solid var(--border); border-radius:14px; padding:4px 10px; font-size:11px; color:var(--text-dim); font-family:inherit; }
.apv-browser .apv-page { padding:14px; background:#fff; color:#202124; font-family:Arial,sans-serif; min-height:120px; }
.apv-browser .apv-ddg-logo { font-size:18px; font-weight:700; color:#de5833; margin-bottom:10px; }
.apv-browser .apv-ddg-logo span { color:#4c9; }
.apv-browser .apv-sresult { margin-bottom:12px; }
.apv-browser .apv-sresult a { color:#1a0dab; font-size:13px; text-decoration:none; font-weight:500; }
.apv-browser .apv-sresult a:hover { text-decoration:underline; }
.apv-browser .apv-sresult .apv-surl { color:#006621; font-size:11px; margin:1px 0; }
.apv-browser .apv-sresult .apv-ssnip { color:#545454; font-size:12px; line-height:1.4; }

/* RAG/Knowledge search viewer */
.apv-rag { }
.apv-rag .apv-qbar { display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:10px; }
.apv-rag .apv-qbar svg { width:16px; height:16px; fill:var(--purple); flex-shrink:0; }
.apv-rag .apv-qbar span { font-size:12px; color:var(--text); }
.apv-rag .apv-chunk { padding:8px 10px; background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:6px; }
.apv-rag .apv-chunk-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.apv-rag .apv-chunk-idx { font-size:10px; font-weight:600; color:var(--purple); }
.apv-rag .apv-chunk-score { font-size:10px; padding:1px 6px; border-radius:8px; background:rgba(188,140,255,.12); color:var(--purple); }
.apv-rag .apv-chunk-text { font-size:11px; color:var(--text-dim); line-height:1.5; max-height:80px; overflow:hidden; }

/* Calculator viewer */
.apv-calc { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:8px; }
.apv-calc .apv-expr { font-size:18px; font-family:'Cascadia Code','Fira Code',Consolas,monospace; color:var(--text); text-align:center; word-break:break-all; padding:0 12px; }
.apv-calc .apv-eq { font-size:28px; color:var(--text-dim); }
.apv-calc .apv-result { font-size:32px; font-weight:700; color:var(--green); font-family:'Cascadia Code','Fira Code',Consolas,monospace; }

/* Clock viewer */
.apv-clock { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:6px; }
.apv-clock .apv-time { font-size:40px; font-weight:700; font-family:'Cascadia Code','Fira Code',Consolas,monospace; color:var(--text); letter-spacing:2px; }
.apv-clock .apv-date { font-size:14px; color:var(--text-dim); }

/* Email viewer */
.apv-email { }
.apv-email-hdr { display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:8px; font-size:12px; font-weight:600; color:var(--cyan); }
.apv-email-count { margin-left:auto; font-size:10px; font-weight:400; color:var(--text-dim); }
.apv-email-list { }
.apv-email-item { padding:8px 10px; background:var(--surface); border:1px solid var(--border); border-radius:6px; margin-bottom:4px; cursor:default; }
.apv-email-item:hover { border-color:var(--cyan); }
.apv-email-from { font-size:11px; font-weight:600; color:var(--text); margin-bottom:2px; }
.apv-email-subj { font-size:11px; color:var(--text-dim); margin-bottom:2px; }
.apv-email-date { font-size:10px; color:var(--text-dim); }
.apv-email-meta { padding:8px 10px; background:var(--surface); border:1px solid var(--border); border-radius:6px; margin-bottom:8px; font-size:11px; line-height:1.8; color:var(--text-dim); }
.apv-email-body { padding:10px 12px; background:var(--surface); border:1px solid var(--border); border-radius:6px; font-size:11px; color:var(--text); line-height:1.6; white-space:pre-wrap; word-break:break-word; max-height:300px; overflow-y:auto; }

/* Generic tool viewer */
.apv-generic { }
.apv-generic .apv-gtool { font-size:12px; font-weight:600; padding:2px 8px; border-radius:4px; background:var(--surface2); color:var(--accent); display:inline-block; margin-bottom:8px; }
.apv-generic .apv-glabel { font-size:10px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px; margin-top:8px; }
.apv-generic .apv-gblock { padding:8px 10px; background:var(--surface); border:1px solid var(--border); border-radius:6px; font-family:'Cascadia Code','Fira Code',Consolas,monospace; font-size:11px; color:var(--text-dim); white-space:pre-wrap; word-break:break-all; max-height:200px; overflow-y:auto; }

/* Done state */
.apv-done { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:10px; }
.apv-done-check { width:48px; height:48px; border-radius:50%; background:rgba(63,185,80,.15); display:flex; align-items:center; justify-content:center; font-size:24px; color:var(--green); }
.apv-done-label { font-size:13px; color:var(--text-dim); }
.apv-done-stats { font-size:11px; color:var(--text-dim); display:flex; gap:12px; }
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-overlay" id="loginScreen">
  <div class="login-card">
    <h2><span>WaWi</span> Chatbot Monitor</h2>
    <div class="login-sub">Sign in to access the dashboard</div>
    <div class="login-tabs">
      <button class="login-tab active" id="ltLogin" onclick="loginTab('login')">Login</button>
      <button class="login-tab" id="ltRegister" onclick="loginTab('register')">Register</button>
    </div>
    <div id="loginForm">
      <div class="login-field"><input type="text" id="authUser" placeholder="Username" onkeydown="if(event.key==='Enter')doAuth()"></div>
      <div class="login-field"><input type="password" id="authPass" placeholder="Password" onkeydown="if(event.key==='Enter')doAuth()"></div>
      <button class="login-btn" id="authBtn" onclick="doAuth()">Login</button>
      <div class="login-error" id="authError"></div>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <div class="header">
    <h1><span>WaWi</span> Chatbot Monitor</h1>
    <div class="header-stats">
      <span>Users: <span class="sv" id="hUsers">0</span></span>
      <span>Chats: <span class="sv" id="hChats">0</span></span>
      <span>Errors: <span class="sv" id="hErrors">0</span></span>
      <span>Avg: <span class="sv" id="hAvg">0ms</span></span>
    </div>
    <div class="user-header-info" id="userHeaderInfo">
      <span id="hUserName">admin</span>
      <span class="role-badge admin" id="hUserRole">admin</span>
      <button class="hbtn" onclick="doLogout()">Logout</button>
    </div>
    <button class="hbtn admin-only" id="btnSettings" onclick="openSettings()">Settings</button>
    <button class="hbtn danger admin-only" id="btnClear" onclick="clearEvents()">Clear All</button>
    <div class="cdot" id="connDot" title="Disconnected"></div>
  </div>

  <div class="panels">
    <!-- LEFT: Feed / User Chats -->
    <div class="panel">
      <div class="tabs" id="leftTabs">
        <button class="tab active" data-t="feed" onclick="lTab('feed')">Live Feed <span id="feedCount" style="font-size:10px;color:var(--accent);margin-left:2px">0</span></button>
        <button class="tab admin-only" data-t="userchats" onclick="lTab('userchats')">User Chats <span class="tbadge hide" id="ucBadge">0</span></button>
      </div>
      <div id="tFeed" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="ffilters" id="feedFilters">
          <button class="fbtn on" data-f="all">All</button>
          <button class="fbtn" data-f="chat">Chat</button>
          <button class="fbtn" data-f="query">SQL</button>
          <button class="fbtn" data-f="error">Errors</button>
          <button class="fbtn" data-f="flagged">Flagged</button>
        </div>
        <div class="panel-body" id="feedBody"></div>
      </div>
      <div id="tUserChats" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="userChatsBody"><div class="dempty">No active chat sessions</div></div>
      </div>
    </div>

    <!-- CENTER: Chat / Detail / SQL -->
    <div class="panel">
      <div class="tabs" id="centerTabs">
        <button class="tab active" data-t="chat" onclick="cTab('chat')">Chat</button>
        <button class="tab" data-t="detail" onclick="cTab('detail')">Detail</button>
        <button class="tab staff-only" data-t="sql" onclick="cTab('sql')">SQL <span class="tbadge hide" id="sqlBadge">0</span></button>
        <button class="tab admin-only" data-t="adminchat" onclick="cTab('adminchat')" id="adminChatTab" style="display:none">View Chat</button>
      </div>
      <div id="tChat" style="display:flex;flex-direction:column;flex:1;overflow:hidden;position:relative">
        <div class="drop-overlay" id="chatDropOverlay"><span>Datei hier ablegen</span></div>
        <div class="cmsg" id="chatMessages"><div class="cempty"><div>Ask the chatbot anything</div><div style="font-size:11px;opacity:.6">Messages go to your local Ollama</div></div></div>
        <div class="usage-bar" id="usageBar">
          <div class="ub-item"><span class="ub-label">Session:</span> <span class="ub-val accent" id="ubTotal">0</span> <span class="ub-label">tokens</span></div>
          <div class="ub-sep"></div>
          <div class="ub-item ub-msg"><span class="ub-dot in"></span> <span class="ub-val" id="ubLastIn">0</span></div>
          <div class="ub-item ub-msg"><span class="ub-dot out"></span> <span class="ub-val" id="ubLastOut">0</span></div>
          <div class="ub-sep"></div>
          <div class="ub-item"><span class="ub-label">Requests:</span> <span class="ub-val" id="ubReqs">0</span></div>
        </div>
        <div class="cinput">
          <div id="dsgvoChatBanner" style="display:none;padding:4px 10px;background:rgba(210,153,34,.1);border:1px solid rgba(210,153,34,.3);border-radius:4px;margin-bottom:4px;font-size:10px;color:var(--orange)">DSGVO: Online-Provider aktiv &mdash; DB, RAG und E-Mail-Zugriff gesperrt</div>
          <div id="chatFilePreview" style="display:none;padding:4px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;margin-bottom:4px;font-size:11px;color:var(--text-dim)">
            <span id="chatFileName"></span>
            <button onclick="clearChatFile()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;margin-left:6px" title="Datei entfernen">&times;</button>
          </div>
          <div class="crow">
            <input type="file" id="chatFileInput" accept=".txt,.md,.csv,.json,.log,.xlsx,.xls,.pdf,.docx,.xml,.html,.htm,.yaml,.yml,.ini,.cfg,.sql,.py,.js,.ts,.tsx,.jsx,.java,.cs,.cpp,.c,.h,.sh,.bat,.ps1,.toml,.properties" style="display:none" onchange="onChatFileSelected(this)">
            <button onclick="$('chatFileInput').click()" title="Datei anhängen" style="min-height:38px;padding:8px 10px;font-size:16px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-dim);cursor:pointer">&#128206;</button>
            <textarea class="cin" id="chatInput" rows="1" placeholder="Type a message..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
            <button class="csend" id="chatSendBtn" onclick="sendChat()">Send</button>
            <button class="hbtn" id="newChatBtn" onclick="newChat()" title="Clear conversation history and start fresh" style="min-height:38px;padding:8px 12px;font-size:12px">New Chat</button>
          </div>
          <div class="ccfg">
            <label>Model</label><select id="modelSel"><option>loading...</option></select>
            <label style="margin-left:8px" class="admin-only" id="chatUidLabel">User</label><input id="chatUid" value="admin" style="width:80px" class="admin-only">
          </div>
        </div>
      </div>
      <div id="tDetail" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="detailBody"><div class="dempty">Select an event from the feed</div></div>
        <div class="mbar" id="modBar" style="display:none">
          <button class="mbtn" id="btnFlag" onclick="toggleFlag()">Flag</button>
          <button class="mbtn" id="btnReview" onclick="toggleReview()">Reviewed</button>
          <input class="nin" id="noteIn" placeholder="Add note..." onkeydown="if(event.key==='Enter')saveNote()">
          <button class="mbtn" onclick="saveNote()">Save</button>
        </div>
      </div>
      <div id="tSql" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div id="sqlRunBar" class="admin-only" style="padding:8px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;display:none">
          <div style="display:flex;gap:4px">
            <input id="sqlRunInput" placeholder="SELECT * FROM ..." style="flex:1;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;font-family:'Cascadia Code','Fira Code',Consolas,monospace;outline:none" onkeydown="if(event.key==='Enter')runSqlQuery()">
            <button class="mbtn" onclick="runSqlQuery()" style="font-size:11px;white-space:nowrap">Run Query</button>
          </div>
          <div id="sqlRunResult" style="margin-top:6px;max-height:300px;overflow:auto"></div>
        </div>
        <div class="panel-body" id="sqlBody"><div class="dempty">SQL queries will appear here</div></div>
      </div>
      <div id="tAdminChat" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div id="adminChatHeader" style="padding:10px 12px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span class="badge buser" id="acUser">—</span>
            <span class="badge bmod" id="acModel">—</span>
            <span style="font-size:11px;color:var(--text-dim)" id="acMsgCount">0 messages</span>
            <span style="font-size:11px;color:var(--text-dim)" id="acStarted">—</span>
            <span style="font-size:10px;color:var(--green);margin-left:auto" id="acLive">LIVE</span>
          </div>
        </div>
        <div class="cmsg" id="adminChatMessages"><div class="dempty">Select a session from User Chats</div></div>
      </div>
    </div>

    <!-- RIGHT: Users / Stats -->
    <div class="panel">
      <div class="tabs">
        <button class="tab active admin-only" data-t="users" onclick="rTab('users')">Users <span class="tbadge hide" id="usersBadge">0</span></button>
        <button class="tab" data-t="stats" onclick="rTab('stats')">Stats</button>
        <button class="tab admin-only" data-t="accounts" onclick="rTab('accounts')">Accounts</button>
        <button class="tab staff-only" data-t="knowledge" onclick="rTab('knowledge')">Knowledge</button>
      </div>
      <div id="tUsers" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="usersBody"><div class="dempty">No users yet</div></div>
      </div>
      <div id="tStats" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="statsBody"></div>
      </div>
      <div id="tAccounts" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="accountsBody"><div class="dempty">Loading accounts...</div></div>
      </div>
      <div id="tKnowledge" style="display:none;flex-direction:column;flex:1;overflow:hidden">
        <div class="panel-body" id="knowledgeBody">
          <div class="sc admin-only" style="padding:10px">
            <div class="sl">Upload Document</div>
            <div style="margin-top:8px">
              <input type="file" id="kbFileInput" accept=".txt,.md,.csv,.json,.log,.xlsx,.xls,.pdf,.docx,.xml,.html,.htm,.yaml,.yml,.ini,.cfg,.sql,.py,.js,.ts,.tsx,.jsx,.java,.cs,.cpp,.c,.h,.sh,.bat,.ps1,.toml,.properties" style="font-size:11px;color:var(--text-dim);margin-bottom:6px;display:block;width:100%">
              <button class="mbtn" onclick="uploadKbFile()" style="font-size:11px;width:100%;margin-top:4px">Upload File</button>
            </div>
            <div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
              <input id="kbTextTitle" placeholder="Title..." style="width:100%;padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box">
              <textarea id="kbTextContent" rows="3" placeholder="Paste text here..." style="width:100%;padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px;resize:vertical;font-family:inherit;box-sizing:border-box"></textarea>
              <button class="mbtn" onclick="uploadKbText()" style="font-size:11px;width:100%;margin-top:4px">Add Text</button>
            </div>
            <div id="kbUploadStatus" style="font-size:11px;margin-top:6px;min-height:16px"></div>
          </div>

          <div class="sc admin-only" style="padding:10px;margin-top:8px;border:1px solid rgba(88,166,255,.2);background:rgba(88,166,255,.04)">
            <div class="sl" style="display:flex;align-items:center;gap:8px">
              <span>Knowledge Folder</span>
              <button class="mbtn" onclick="syncKnowledgeFolder()" id="btnKbSync" style="font-size:10px;padding:2px 10px">Sync Now</button>
              <span id="kbSyncStatus" style="font-size:10px;color:var(--text-dim)"></span>
            </div>
            <div style="font-size:10px;color:var(--text-dim);margin:4px 0 6px">
              Drop files into <code id="kbFolderPath" style="background:var(--surface2);padding:1px 4px;border-radius:3px">knowledge/</code> and click Sync to index them automatically.
              <br>Supports: PDF, DOCX, XLSX, TXT, MD, CSV, JSON, XML, HTML, YAML, code files, and more.
            </div>
            <div id="kbFolderFiles" style="max-height:200px;overflow-y:auto"></div>
          </div>

          <div class="stitle">Documents</div>
          <div id="kbDocList"><div style="color:var(--text-dim);font-size:11px">No documents uploaded</div></div>

          <div class="stitle">Stats</div>
          <div id="kbStats" class="sc" style="padding:8px"><span style="color:var(--text-dim);font-size:11px">Loading...</span></div>

          <div class="stitle">Search Test</div>
          <div style="display:flex;gap:4px;margin-bottom:6px">
            <input id="kbSearchInput" placeholder="Test query..." style="flex:1;padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px" onkeydown="if(event.key==='Enter')searchKb()">
            <button class="mbtn" onclick="searchKb()" style="font-size:11px">Search</button>
          </div>
          <div id="kbSearchResults"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Agent Viewer Panel -->
<div class="agent-panel" id="agentPanel">
  <div class="ap-header">
    <div class="ap-title">Agent Viewer</div>
    <span class="ap-status running" id="apStatus">Running</span>
    <button class="ap-close" id="apClose" onclick="closeAgentPanel()" title="Close">&times;</button>
  </div>
  <div class="ap-body">
    <div class="ap-timeline" id="apTimeline"></div>
    <div class="ap-viewer" id="apViewer">
      <div class="apv-thinking"><div class="apv-orb"></div><div class="apv-orb-label">Waiting for agent...</div></div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="mbox">
    <h2>Chatbot Settings</h2>
    <div class="mf"><label>LLM Provider</label>
      <select id="cfgProvider" onchange="onProviderChange()">
        <option value="ollama">Ollama (Local)</option>
        <option value="openai">OpenAI (ChatGPT)</option>
        <option value="anthropic">Anthropic (Claude)</option>
        <option value="openrouter">OpenRouter (OAuth Login)</option>
      </select>
    </div>
    <div class="mf" id="cfgOllamaRow"><label>Ollama URL</label><input id="cfgUrl" value="http://localhost:11434"></div>
    <div class="mf" id="cfgOpenaiOAuthRow" style="display:none"><label>OpenAI Account</label>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="mbtn" style="font-size:12px;padding:6px 14px;background:#10a37f;color:#fff;border-color:#10a37f" onclick="loginOpenAI()" id="oaiLoginBtn">Login with OpenAI</button>
        <span id="oaiStatus" style="font-size:11px;color:var(--text-dim)"></span>
      </div>
      <div style="font-size:10px;color:var(--text-dim);margin-top:4px">Log in with your OpenAI account via OAuth. No API key needed.</div>
    </div>
    <div class="mf" id="cfgOpenaiKeyRow" style="display:none"><label>OpenAI API Key <span style="font-size:9px;text-transform:none;letter-spacing:0">(or use Login above)</span></label>
      <div style="display:flex;gap:4px"><input id="cfgOpenaiKey" type="password" placeholder="sk-..." style="flex:1"><button class="mbtn" style="font-size:10px;white-space:nowrap" onclick="toggleKeyVis('cfgOpenaiKey',this)">Show</button></div>
    </div>
    <div class="mf" id="cfgOpenaiUrlRow" style="display:none"><label>OpenAI Base URL</label><input id="cfgOpenaiUrl" value="https://api.openai.com/v1" placeholder="https://api.openai.com/v1"></div>
    <div class="mf" id="cfgAnthropicKeyRow" style="display:none"><label>Anthropic API Key</label>
      <div style="display:flex;gap:4px"><input id="cfgAnthropicKey" type="password" placeholder="sk-ant-..." style="flex:1"><button class="mbtn" style="font-size:10px;white-space:nowrap" onclick="toggleKeyVis('cfgAnthropicKey',this)">Show</button></div>
    </div>
    <div class="mf" id="cfgOpenrouterRow" style="display:none"><label>OpenRouter</label>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="mbtn" style="font-size:12px;padding:6px 14px;background:var(--accent);color:#fff;border-color:var(--accent)" onclick="loginOpenRouter()" id="orLoginBtn">Login with OpenRouter</button>
        <span id="orStatus" style="font-size:11px;color:var(--text-dim)"></span>
      </div>
      <div style="font-size:10px;color:var(--text-dim);margin-top:4px">Opens OpenRouter.ai — log in to grant access to GPT-4, Claude, and 200+ models. No API key needed.</div>
    </div>
    <div class="mf"><label>Default Model</label><select id="cfgModel"><option>loading...</option></select></div>
    <div class="mf"><label>System Prompt</label><textarea id="cfgPrompt" placeholder="e.g. Du bist ein WaWi-Assistent."></textarea></div>
    <div class="mf"><label>Temperature</label><input id="cfgTemp" type="number" min="0" max="2" step="0.1" value="0.7"></div>

    <div id="dsgvoSettingsWarn" style="display:none;background:rgba(210,153,34,.12);border:1px solid var(--orange);border-radius:6px;padding:10px 12px;margin:10px 0;font-size:11px;color:var(--orange)">
      <strong>DSGVO-Hinweis:</strong> Bei Online-Providern (OpenAI, Anthropic, OpenRouter) werden Datenbank-, Wissensdatenbank- und E-Mail-Zugriff automatisch gesperrt, da Daten an externe Server gesendet wuerden. Nur mit Ollama (lokal) sind alle Tools verfuegbar.
    </div>

    <div style="border-top:1px solid var(--border);margin:14px 0 10px;padding-top:10px">
      <div style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Database Connection</div>
    </div>
    <div class="mf" style="display:flex;align-items:center;gap:8px">
      <label style="display:inline;margin:0">Enable Database</label>
      <input type="checkbox" id="cfgDbEnabled">
    </div>
    <div class="mf"><label>Database Type</label>
      <select id="cfgDbType" onchange="onDbTypeChange()">
        <option value="">None</option>
        <option value="mssql">MSSQL</option>
        <option value="sqlite">SQLite</option>
      </select>
    </div>
    <div id="cfgDbMssqlRows" style="display:none">
      <div class="mf"><label>Server</label><input id="cfgDbMssqlServer" placeholder="localhost\JTLWAWI"></div>
      <div class="mf"><label>Database</label><input id="cfgDbMssqlDatabase" placeholder="eazybusiness"></div>
      <div class="mf"><label>Username</label><input id="cfgDbMssqlUser" placeholder="sa"></div>
      <div class="mf"><label>Password</label><input id="cfgDbMssqlPassword" type="password" placeholder="****"></div>
      <div class="mf"><label>ODBC Driver</label><input id="cfgDbMssqlDriver" placeholder="ODBC Driver 17 for SQL Server"></div>
    </div>
    <div id="cfgDbSqliteRows" style="display:none">
      <div class="mf"><label>File Path</label><input id="cfgDbSqlitePath" placeholder="./data/mydb.db"></div>
    </div>
    <div class="mf">
      <button class="mbtn" onclick="testDbConnection()" id="btnTestDb" style="font-size:12px;padding:6px 14px">Test Connection</button>
      <span id="dbTestResult" style="font-size:11px;margin-left:8px"></span>
    </div>

    <div style="border-top:1px solid var(--border);margin:14px 0 10px;padding-top:10px">
      <div style="font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Knowledge Base (RAG)</div>
    </div>
    <div class="mf" style="display:flex;align-items:center;gap:8px">
      <label style="display:inline;margin:0">Enable RAG</label>
      <input type="checkbox" id="cfgRagEnabled">
    </div>
    <div class="mf"><label>Embedding Provider</label>
      <select id="cfgEmbeddingProvider">
        <option value="auto">Auto (OpenAI if key, else Ollama)</option>
        <option value="openai">OpenAI</option>
        <option value="ollama">Ollama</option>
      </select>
    </div>
    <div class="mf"><label>Embedding Model</label><input id="cfgEmbeddingModel" placeholder="text-embedding-3-small or nomic-embed-text"></div>
    <div class="mf"><label>Top-K Results</label><input id="cfgRagTopK" type="number" min="1" max="20" value="5"></div>

    <div style="border-top:1px solid var(--border);margin:14px 0 10px;padding-top:10px">
      <div style="font-size:12px;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Agent Mode</div>
    </div>
    <div class="mf" style="display:flex;align-items:center;gap:8px">
      <label style="display:inline;margin:0">Enable Agent Mode</label>
      <input type="checkbox" id="cfgAgentEnabled">
    </div>
    <div style="font-size:10px;color:var(--text-dim);margin:-8px 0 10px;padding-left:2px">When enabled, the LLM can autonomously call tools (DB, RAG, web search, calculator, etc.) to answer questions.</div>
    <div class="mf"><label>Max Steps</label><input id="cfgAgentMaxSteps" type="number" min="1" max="20" value="8"></div>
    <div class="mf" style="display:flex;align-items:center;gap:8px">
      <label style="display:inline;margin:0">Web Search</label>
      <input type="checkbox" id="cfgAgentWebSearch" checked>
    </div>

    <div style="border-top:1px solid var(--border);margin:14px 0 10px;padding-top:10px">
      <div style="font-size:12px;font-weight:600;color:var(--cyan);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Email (IMAP)</div>
    </div>
    <div class="mf" style="display:flex;align-items:center;gap:8px">
      <label style="display:inline;margin:0">Enable Email Access</label>
      <input type="checkbox" id="cfgEmailEnabled">
    </div>
    <div style="font-size:10px;color:var(--text-dim);margin:-8px 0 10px;padding-left:2px">Allows the agent to search and read emails. Only available with Ollama (DSGVO).</div>
    <div class="mf"><label>IMAP Server</label><input id="cfgEmailImapServer" value="outlook.office365.com" placeholder="outlook.office365.com"></div>
    <div class="mf"><label>IMAP Port</label><input id="cfgEmailImapPort" type="number" value="993" placeholder="993"></div>
    <div class="mf"><label>Email Address</label><input id="cfgEmailAddress" placeholder="info@example.com"></div>
    <div class="mf"><label>Password</label>
      <div style="display:flex;gap:4px"><input id="cfgEmailPassword" type="password" placeholder="****" style="flex:1"><button class="mbtn" style="font-size:10px;white-space:nowrap" onclick="toggleKeyVis('cfgEmailPassword',this)">Show</button></div>
    </div>
    <div class="mf">
      <button class="mbtn" onclick="testEmailConnection()" id="btnTestEmail" style="font-size:12px;padding:6px 14px">Test Connection</button>
      <span id="emailTestResult" style="font-size:11px;margin-left:8px"></span>
    </div>

    <div class="mactions"><button onclick="closeSettings()">Cancel</button><button class="primary" onclick="saveSettings()">Save</button></div>
  </div>
</div>

<script>
let events=[],moderation={},usersMap={},selectedId=null,selectedUser=null;
let activeFilter='all',centerTab='chat',rightTab='users',leftTab='feed';
let connected=false,sending=false,chatHistory=[],ollamaModels=[],appCfg={};
let currentUser=null; // {username, role}
let authMode='login';
let statsInterval=null;
let adminChatSessions=[],viewingSessionId=null,ucRefreshTimer=null;

// ---- Auth Flow ----
async function checkAuth(){
  try{
    const r=await fetch('/api/auth/me');
    if(r.ok){const d=await r.json();currentUser=d.user;showDashboard()}
    else showLogin();
  }catch(e){showLogin()}
}
function showLogin(){
  $('loginScreen').style.display='flex';
  document.querySelector('.app').style.display='none';
  $('authUser').focus();
}
function showDashboard(){
  $('loginScreen').style.display='none';
  document.querySelector('.app').style.display='grid';
  $('hUserName').textContent=currentUser.username;
  const rb=$('hUserRole');rb.textContent=currentUser.role;rb.className='role-badge '+currentUser.role;
  if(currentUser.role!=='admin')$('chatUid').value=currentUser.username;
  applyRole(currentUser.role);
  connectSSE();
  loadModels();
  loadUsage();
  if(currentUser.role==='admin'){
    loadCfg();
    statsInterval=setInterval(refreshStats,10000);
    setTimeout(refreshStats,500);
  }
}
function applyRole(role){
  // admin-only: settings, clear all, accounts, user management, moderation, raw SQL
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display=role==='admin'?'':'none';
  });
  // mitarbeiter-only: Knowledge tab (view-only), SQL query log
  document.querySelectorAll('.staff-only').forEach(el=>{
    el.style.display=(role==='admin'||role==='mitarbeiter')?'':'none';
  });
  // For non-admin: hide moderation bar, switch to stats tab on right
  if(role!=='admin'){
    $('modBar').style.display='none';
    if(role==='mitarbeiter') rTab('stats');
    else rTab('stats');
  }
}
function loginTab(mode){
  authMode=mode;
  $('ltLogin').classList.toggle('active',mode==='login');
  $('ltRegister').classList.toggle('active',mode==='register');
  $('authBtn').textContent=mode==='login'?'Login':'Register';
  $('authError').textContent='';
}
async function doAuth(){
  const user=$('authUser').value.trim(),pass=$('authPass').value;
  if(!user||!pass){$('authError').textContent='Enter username and password';return}
  $('authBtn').disabled=true;$('authError').textContent='';
  const endpoint=authMode==='login'?'/api/auth/login':'/api/auth/register';
  try{
    const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pass})});
    const d=await r.json();
    if(r.ok&&d.ok){currentUser=d.user;showDashboard()}
    else{
      const msg=d.error==='invalid_credentials'?'Invalid username or password':d.error==='username_taken'?'Username already taken':d.error||'Login failed';
      $('authError').textContent=msg;
    }
  }catch(e){$('authError').textContent='Connection error: '+e.message}
  $('authBtn').disabled=false;
}
async function doLogout(){
  try{await fetch('/api/auth/logout',{method:'POST'})}catch(e){}
  currentUser=null;events=[];moderation={};usersMap={};
  if(statsInterval){clearInterval(statsInterval);statsInterval=null}
  if(ucRefreshTimer){clearInterval(ucRefreshTimer);ucRefreshTimer=null}
  viewingSessionId=null;adminChatSessions=[];
  showLogin();
}

// ---- SSE ----
function connectSSE(){
  const es=new EventSource('/api/stream'),dot=$('connDot');
  es.onopen=()=>{connected=true;dot.className='cdot on';dot.title='Connected'};
  es.onerror=()=>{connected=false;dot.className='cdot';dot.title='Reconnecting...'};
  es.addEventListener('session',e=>{const s=JSON.parse(e.data);currentUser=s;applyRole(s.role)});
  es.addEventListener('init',e=>{events=JSON.parse(e.data);renderFeed();renderSql();if(currentUser?.role==='admin')refreshStats()});
  es.addEventListener('moderation',e=>{moderation=JSON.parse(e.data);renderFeed();if(selectedId)renderDetail(selectedId)});
  es.addEventListener('users',e=>{usersMap=JSON.parse(e.data);renderUsers()});
  es.onmessage=e=>{
    const evt=JSON.parse(e.data);
    if(evt.type==='_clear'){events=[];moderation={};selectedId=null;renderFeed();renderSql();if(currentUser?.role==='admin')refreshStats();$('detailBody').innerHTML='<div class="dempty">Select an event</div>';$('modBar').style.display='none';return}
    if(evt.type==='_moderation_update'){moderation[evt.event_id]=evt.moderation;renderFeed();if(selectedId===evt.event_id)renderDetail(selectedId);if(currentUser?.role==='admin')refreshStats();return}
    if(evt.type==='_user_update'){if(usersMap[evt.user_id])usersMap[evt.user_id].status=evt.status;renderUsers();if(selectedUser===evt.user_id)showUserDetail(evt.user_id);return}
    if(evt.type==='_agent_start'){handleAgentStart(evt);return}
    if(evt.type==='_agent_thinking'){handleAgentThinking(evt);return}
    if(evt.type==='_agent_step'){handleAgentStep(evt);return}
    if(evt.type==='_agent_done'){handleAgentDone(evt);return}
    events.push(evt);if(events.length>5000)events.shift();
    addFeedItem(evt);if(evt.type==='query')addSqlItem(evt);
    if(evt.user_id&&evt.user_id!=='admin'){
      if(!usersMap[evt.user_id])usersMap[evt.user_id]={user_id:evt.user_id,status:'active',first_seen:evt.timestamp,last_seen:evt.timestamp,message_count:0};
      usersMap[evt.user_id].last_seen=evt.timestamp;
      if(evt.type==='chat')usersMap[evt.user_id].message_count=(usersMap[evt.user_id].message_count||0)+1;
      renderUsers();
    }
    if(currentUser?.role==='admin'){refreshStats();if(evt.type==='chat'&&leftTab==='userchats')loadUserChatSessions();if(evt.type==='chat'&&viewingSessionId)refreshAdminChat()}
  };
}

// ---- Tabs ----
function cTab(t){centerTab=t;document.querySelectorAll('#centerTabs .tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));$('tChat').style.display=t==='chat'?'flex':'none';$('tDetail').style.display=t==='detail'?'flex':'none';$('tSql').style.display=t==='sql'?'flex':'none';$('tAdminChat').style.display=t==='adminchat'?'flex':'none';if(t==='chat')$('chatInput').focus();if(t==='sql'&&currentUser?.role==='admin'&&appCfg.db_enabled)$('sqlRunBar').style.display='block';else $('sqlRunBar').style.display='none'}
function rTab(t){rightTab=t;document.querySelectorAll('.panel:last-child .tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));$('tUsers').style.display=t==='users'?'flex':'none';$('tStats').style.display=t==='stats'?'flex':'none';$('tAccounts').style.display=t==='accounts'?'flex':'none';$('tKnowledge').style.display=t==='knowledge'?'flex':'none';if(t==='accounts')loadAccounts();if(t==='knowledge')loadKnowledge()}
function lTab(t){leftTab=t;document.querySelectorAll('#leftTabs .tab').forEach(b=>b.classList.toggle('active',b.dataset.t===t));$('tFeed').style.display=t==='feed'?'flex':'none';$('tUserChats').style.display=t==='userchats'?'flex':'none';if(t==='userchats')loadUserChatSessions()}

// ---- Chat file upload ----
let chatFileData=null; // {filename, content}
function onChatFileSelected(input){
  if(!input.files?.length)return;
  const file=input.files[0];
  const fd=new FormData();fd.append('file',file);
  $('chatFileName').textContent='Lade: '+file.name+'...';
  $('chatFilePreview').style.display='flex';
  fetch('/api/chat/upload',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
    if(d.ok){chatFileData={filename:d.filename,content:d.content};$('chatFileName').textContent='📎 '+d.filename+(d.truncated?' (gekürzt)':'');$('chatFilePreview').style.display='flex'}
    else{clearChatFile();alert('Fehler: '+(d.error||'Upload fehlgeschlagen'))}
  }).catch(e=>{clearChatFile();alert('Upload Fehler: '+e.message)});
}
function clearChatFile(){chatFileData=null;$('chatFileInput').value='';$('chatFilePreview').style.display='none';$('chatFileName').textContent=''}

// ---- Drag & drop file upload ----
(function(){
  const zone=$('tChat');if(!zone)return;
  let dragCount=0;
  const ov=$('chatDropOverlay');
  zone.addEventListener('dragenter',e=>{e.preventDefault();dragCount++;ov.classList.add('active')});
  zone.addEventListener('dragleave',e=>{e.preventDefault();dragCount--;if(dragCount<=0){dragCount=0;ov.classList.remove('active')}});
  zone.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy'});
  zone.addEventListener('drop',e=>{
    e.preventDefault();dragCount=0;ov.classList.remove('active');
    const files=e.dataTransfer.files;if(!files?.length)return;
    const file=files[0];
    const fd=new FormData();fd.append('file',file);
    $('chatFileName').textContent='Lade: '+file.name+'...';
    $('chatFilePreview').style.display='flex';
    fetch('/api/chat/upload',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
      if(d.ok){chatFileData={filename:d.filename,content:d.content};$('chatFileName').textContent='\u{1F4CE} '+d.filename+(d.truncated?' (gek\u00FCrzt)':'');$('chatFilePreview').style.display='flex'}
      else{clearChatFile();alert('Fehler: '+(d.error||'Upload fehlgeschlagen'))}
    }).catch(err=>{clearChatFile();alert('Upload Fehler: '+err.message)});
  });
})();

// ---- Token usage tracking ----
let sessionUsage={prompt_tokens:0,completion_tokens:0,total_tokens:0,requests:0};
function fmtTokens(n){if(n>=1000000)return(n/1000000).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'k';return n.toString()}
function updateUsageBar(msgUsage){
  if(msgUsage&&msgUsage.total_tokens>0){
    sessionUsage.prompt_tokens+=msgUsage.prompt_tokens||0;
    sessionUsage.completion_tokens+=msgUsage.completion_tokens||0;
    sessionUsage.total_tokens+=msgUsage.total_tokens||0;
    sessionUsage.requests++;
    $('ubLastIn').textContent=fmtTokens(msgUsage.prompt_tokens||0);
    $('ubLastOut').textContent=fmtTokens(msgUsage.completion_tokens||0);
  }
  $('ubTotal').textContent=fmtTokens(sessionUsage.total_tokens);
  $('ubReqs').textContent=sessionUsage.requests;
  // Show bar only when there's actual usage (API/OAuth providers)
  const bar=$('usageBar');
  if(sessionUsage.total_tokens>0)bar.classList.add('visible');
  else bar.classList.remove('visible');
}
function resetUsageBar(){sessionUsage={prompt_tokens:0,completion_tokens:0,total_tokens:0,requests:0};$('usageBar').classList.remove('visible')}
// Fetch cumulative usage from server on login
async function loadUsage(){
  try{
    const r=await fetch('/api/usage');if(!r.ok)return;
    const d=await r.json();
    if(d.user&&d.user.total_tokens>0){
      sessionUsage=d.user;
      $('ubTotal').textContent=fmtTokens(sessionUsage.total_tokens);
      $('ubReqs').textContent=sessionUsage.requests;
      $('ubLastIn').textContent='-';$('ubLastOut').textContent='-';
      $('usageBar').classList.add('visible');
    }
  }catch(e){}
}

// ---- Chat ----
async function sendChat(){
  if(sending)return;const inp=$('chatInput'),q=inp.value.trim();if(!q)return;
  const model=$('modelSel').value;
  const uid=currentUser?.role==='admin'?($('chatUid').value||currentUser.username):currentUser.username;
  const displayMsg=chatFileData?'📎 '+chatFileData.filename+'\n'+q:q;
  chatHistory.push({role:'user',content:displayMsg});renderChatMsgs();inp.value='';inp.style.height='auto';
  sending=true;$('chatSendBtn').disabled=true;
  const th=document.createElement('div');th.className='cthink';th.id='thinkInd';th.innerHTML='<div class="dots"><span></span><span></span><span></span></div>';$('chatMessages').appendChild(th);scrollChat();
  try{
    const body={question:q,model};
    if(chatFileData){body.file_context=chatFileData.content;body.file_name=chatFileData.filename}
    if(currentUser?.role==='admin')body.user_id=uid;
    const r=await fetch('/api/chat?stream=1',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const ct=r.headers.get('content-type')||'';
    if(ct.includes('text/event-stream')){
      // Streaming response — render tokens live
      $('thinkInd')?.remove();
      const liveBub=document.createElement('div');liveBub.className='bubble a';
      liveBub.innerHTML='<div class="bl">Bot</div><span class="stream-text"></span><span class="stream-cursor">▌</span><div class="bm" style="display:none"></div>';
      $('chatMessages').appendChild(liveBub);scrollChat();
      const stEl=liveBub.querySelector('.stream-text');
      const bmEl=liveBub.querySelector('.bm');
      let fullText='',meta=null;
      const reader=r.body.getReader();
      const decoder=new TextDecoder();
      let buf='';
      while(true){
        const{done,value}=await reader.read();
        if(done)break;
        buf+=decoder.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop();
        for(const line of lines){
          if(!line.startsWith('data: '))continue;
          try{
            const d=JSON.parse(line.slice(6));
            if(d.token){fullText+=d.token;stEl.textContent=fullText;scrollChat()}
            if(d.error){fullText='Error: '+d.error;stEl.textContent=fullText}
            if(d.done){meta=d}
          }catch(e){}
        }
      }
      liveBub.querySelector('.stream-cursor')?.remove();
      if(meta){
        bmEl.style.display='';
        bmEl.innerHTML=(meta.model?`<span>${esc(meta.model)}</span>`:'')+(meta.duration_ms?`<span>${fmtDur(meta.duration_ms)}</span>`:'')+
          (meta.token_usage&&meta.token_usage.total_tokens?` <span title="In: ${meta.token_usage.prompt_tokens} / Out: ${meta.token_usage.completion_tokens}">${fmtTokens(meta.token_usage.total_tokens)} tok</span>`:'');
        chatHistory.push({role:'bot',content:fullText,model:meta.model,ms:meta.duration_ms,usage:meta.token_usage||null,tool_log:null});
        updateUsageBar(meta.token_usage);
      }else{
        chatHistory.push({role:'bot',content:fullText,model,ms:0,usage:null,tool_log:null});
      }
    }else{
      // Non-streaming fallback (agent mode, DB mode, or server doesn't support stream)
      const d=await r.json();$('thinkInd')?.remove();
      if(d.ok){chatHistory.push({role:'bot',content:d.answer,model:d.model,ms:d.duration_ms,usage:d.token_usage,tool_log:d.tool_log||null});updateUsageBar(d.token_usage)}
      else chatHistory.push({role:'error',content:d.error||'Unknown error'});
    }
  }catch(err){$('thinkInd')?.remove();chatHistory.push({role:'error',content:err.message})}
  clearChatFile();
  sending=false;$('chatSendBtn').disabled=false;renderChatMsgs();$('chatInput').focus();
}
function renderChatMsgs(){
  const c=$('chatMessages');
  if(!chatHistory.length){const prov=(appCfg.provider||'ollama').charAt(0).toUpperCase()+(appCfg.provider||'ollama').slice(1);c.innerHTML=`<div class="cempty"><div>Ask the chatbot anything</div><div style="font-size:11px;opacity:.6">Provider: ${esc(prov)}</div></div>`;return}
  c.innerHTML=chatHistory.map(m=>{
    if(m.role==='user')return`<div class="bubble q"><div class="bl">You</div>${esc(m.content)}</div>`;
    if(m.role==='error')return`<div class="bubble a" style="border-color:var(--red)"><div class="bl" style="color:var(--red)">Error</div>${esc(m.content)}</div>`;
    const tok=m.usage&&m.usage.total_tokens?` <span title="In: ${m.usage.prompt_tokens} / Out: ${m.usage.completion_tokens}">${fmtTokens(m.usage.total_tokens)} tok</span>`:'';
    const agentBadge=m.tool_log&&m.tool_log.length?'<span class="agent-badge">Agent</span>':'';
    const toolLogHtml=renderToolLog(m.tool_log);
    return`<div class="bubble a"><div class="bl">Bot${agentBadge}</div>${esc(m.content)}${toolLogHtml}<div class="bm">${m.model?`<span>${esc(m.model)}</span>`:''}${m.ms?`<span>${fmtDur(m.ms)}</span>`:''}${tok}</div></div>`;
  }).join('');scrollChat();
}
function scrollChat(){const c=$('chatMessages');c.scrollTop=c.scrollHeight}
function renderToolLog(log){
  if(!log||!log.length)return'';
  let steps=log.map(t=>{
    const inp=typeof t.input==='object'?JSON.stringify(t.input):String(t.input||'');
    const out=String(t.output||'').substring(0,500);
    return`<div class="tool-step"><span class="tool-name tn-${esc(t.tool)}">${esc(t.tool)}</span> <span style="font-size:10px;color:var(--text-dim)">step ${t.step}</span><pre class="tool-input">${esc(inp)}</pre><pre class="tool-output">${esc(out)}</pre></div>`;
  }).join('');
  return`<div class="tool-log"><div class="tool-log-header" onclick="this.parentElement.classList.toggle('open')">🔧 ${log.length} tool${log.length>1?'s':''} used <span class="toggle-arrow">▶</span></div><div class="tool-log-body">${steps}</div></div>`;
}
$('chatInput').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'});

// ---- Agent Viewer Panel ----
let agentRunId=null,agentSteps=[],agentAutoFollow=true,agentActiveStep=-1,agentPanelOpen=false;

function openAgentPanel(){
  agentPanelOpen=true;
  $('agentPanel').classList.add('open');
}
function closeAgentPanel(){
  agentPanelOpen=false;
  $('agentPanel').classList.remove('open');
}

function toolColor(name){
  if(name==='query_database'||name==='list_tables')return'db';
  if(name==='web_search')return'web';
  if(name==='search_knowledge')return'rag';
  if(name==='calculate')return'calc';
  if(name==='get_datetime')return'time';
  if(name==='search_emails'||name==='read_email')return'email';
  return'generic';
}

function handleAgentStart(d){
  agentRunId=d.run_id;agentSteps=[];agentAutoFollow=true;agentActiveStep=-1;
  $('apTimeline').innerHTML='';
  $('apStatus').className='ap-status running';$('apStatus').textContent='Running';
  $('apViewer').innerHTML='<div class="apv-thinking"><div class="apv-orb"></div><div class="apv-orb-label">Agent starting...</div></div>';
  openAgentPanel();
}

function handleAgentThinking(d){
  if(d.run_id!==agentRunId)return;
  const ti=document.createElement('div');
  ti.className='ap-titem';ti.dataset.idx='think-'+d.step;
  ti.innerHTML=`<div class="ap-tn"><span class="ap-tc-think">&#9679;</span> Step ${d.step}</div><div class="ap-td">Thinking...</div>`;
  $('apTimeline').appendChild(ti);
  $('apTimeline').scrollTop=$('apTimeline').scrollHeight;
  if(agentAutoFollow){
    setActiveTimelineItem(ti);
    $('apViewer').innerHTML='<div class="apv-thinking"><div class="apv-orb"></div><div class="apv-orb-label">Thinking... (step '+d.step+')</div></div>';
  }
}

function handleAgentStep(d){
  if(d.run_id!==agentRunId)return;
  const idx=agentSteps.length;
  agentSteps.push(d);
  const tc=toolColor(d.tool);
  // Remove last "thinking" item for this step
  const thinkEl=$('apTimeline').querySelector(`[data-idx="think-${d.step}"]`);
  if(thinkEl)thinkEl.remove();
  // Add step item
  const ti=document.createElement('div');
  ti.className='ap-titem';ti.dataset.idx=idx;
  const inp=typeof d.input==='object'?Object.values(d.input).join(' '):String(d.input||'');
  ti.innerHTML=`<div class="ap-tn"><span class="ap-tc-${tc}">&#9679;</span> ${escA(d.tool)}</div><div class="ap-td">${escA(inp.slice(0,40))}</div><div class="ap-tms">${d.duration_ms}ms</div>`;
  ti.onclick=()=>{agentAutoFollow=false;agentActiveStep=idx;renderAgentViewer(idx);setActiveTimelineItem(ti)};
  $('apTimeline').appendChild(ti);
  $('apTimeline').scrollTop=$('apTimeline').scrollHeight;
  $('apStatus').className='ap-status running';$('apStatus').textContent=`Step ${d.step}`;
  if(agentAutoFollow){agentActiveStep=idx;renderAgentViewer(idx);setActiveTimelineItem(ti)}
}

function handleAgentDone(d){
  if(d.run_id!==agentRunId)return;
  const isErr=d.error===true;
  $('apStatus').className=isErr?'ap-status error':'ap-status done';
  $('apStatus').textContent=isErr?'Error':'Done';
  // Add done item to timeline
  const ti=document.createElement('div');
  ti.className='ap-titem';ti.dataset.idx='done';
  ti.innerHTML=`<div class="ap-tn"><span class="ap-tc-${isErr?'generic':'done'}">&#9679;</span> ${isErr?'Error':'Done'}</div><div class="ap-td">${d.total_steps} steps, ${fmtDur(d.duration_ms)}</div>`;
  ti.onclick=()=>{agentAutoFollow=false;renderAgentDone(d);setActiveTimelineItem(ti)};
  $('apTimeline').appendChild(ti);
  $('apTimeline').scrollTop=$('apTimeline').scrollHeight;
  if(agentAutoFollow){renderAgentDone(d);setActiveTimelineItem(ti)}
}

function setActiveTimelineItem(el){
  $('apTimeline').querySelectorAll('.ap-titem').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
}

function renderAgentViewer(idx){
  const step=agentSteps[idx];if(!step)return;
  const v=$('apViewer');
  switch(step.tool){
    case'query_database':case'list_tables':v.innerHTML=renderDbView(step);break;
    case'web_search':v.innerHTML=renderWebSearchView(step);break;
    case'search_knowledge':v.innerHTML=renderRagView(step);break;
    case'calculate':v.innerHTML=renderCalcView(step);break;
    case'get_datetime':v.innerHTML=renderClockView(step);break;
    case'search_emails':v.innerHTML=renderEmailSearchView(step);break;
    case'read_email':v.innerHTML=renderEmailReadView(step);break;
    default:v.innerHTML=renderGenericToolView(step);
  }
}

function renderDbView(step){
  const sql=typeof step.input==='object'?(step.input.sql||JSON.stringify(step.input)):String(step.input||'');
  const hlSql=sql.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|ORDER BY|GROUP BY|HAVING|LIMIT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|AS|IN|NOT|NULL|IS|LIKE|BETWEEN|COUNT|SUM|AVG|MAX|MIN|DISTINCT|UNION|CASE|WHEN|THEN|ELSE|END)\b/gi,m=>'<span class="kw">'+m.toUpperCase()+'</span>');
  let resultHtml='';
  const out=String(step.output||'');
  // Try to parse as markdown table
  const lines=out.split('\n').filter(l=>l.trim());
  const hasTable=lines.length>=3&&lines[1]&&lines[1].includes('---');
  if(hasTable){
    const headers=lines[0].split('|').map(h=>h.trim()).filter(Boolean);
    const rows=lines.slice(2).map(r=>r.split('|').map(c=>c.trim()).filter(Boolean));
    resultHtml='<table><thead><tr>'+headers.map(h=>'<th>'+escA(h)+'</th>').join('')+'</tr></thead><tbody>'+rows.map(r=>'<tr>'+r.map(c=>'<td>'+escA(c)+'</td>').join('')+'</tr>').join('')+'</tbody></table>';
  } else {
    resultHtml='<pre style="font-size:10px;color:var(--text-dim);white-space:pre-wrap;word-break:break-all">'+escA(out)+'</pre>';
  }
  return`<div class="apv-db"><div class="apv-titlebar"><div class="apv-dot r"></div><div class="apv-dot y"></div><div class="apv-dot g"></div><div class="apv-db-title">${escA(step.tool)} &mdash; ${step.duration_ms}ms</div></div><div class="apv-sql">${hlSql}</div><div class="apv-result">${resultHtml}</div></div>`;
}

function renderWebSearchView(step){
  const query=typeof step.input==='object'?(step.input.query||''):String(step.input||'');
  const out=String(step.output||'');
  // Parse DuckDuckGo-style results
  const results=[];
  const blocks=out.split(/\n\n+/);
  for(const b of blocks){
    const m=b.match(/^(\d+)\.\s*\[(.+?)\]\((.+?)\)\s*\n(.+)/s);
    if(m){results.push({title:m[2],url:m[3],snippet:m[4].trim()})}
    else if(b.trim()&&results.length<8){
      const simpleM=b.match(/^(\d+)\.\s*(.+?)[\n:]\s*(.+)/s);
      if(simpleM){results.push({title:simpleM[2],url:'',snippet:simpleM[3].trim().slice(0,200)})}
    }
  }
  let resultsHtml=results.length?results.map(r=>
    `<div class="apv-sresult"><a>${escA(r.title)}</a>${r.url?'<div class="apv-surl">'+escA(r.url)+'</div>':''}<div class="apv-ssnip">${escA(r.snippet.slice(0,200))}</div></div>`
  ).join(''):`<div style="color:#545454;font-size:12px;padding:8px 0">${escA(out.slice(0,500))}</div>`;
  return`<div class="apv-browser"><div class="apv-bar"><div class="apv-bar-dots"><span></span><span></span><span></span></div><div class="apv-url">duckduckgo.com/?q=${escA(query)}</div></div><div class="apv-page"><div class="apv-ddg-logo">Duck<span>Duck</span>Go</div>${resultsHtml}</div></div>`;
}

function renderRagView(step){
  const query=typeof step.input==='object'?(step.input.query||''):String(step.input||'');
  const out=String(step.output||'');
  // Parse numbered results
  const chunks=[];
  const parts=out.split(/\n\n+/);
  for(const p of parts){
    const m=p.match(/^(\d+)\.\s*\[Score:\s*([\d.]+)\]\s*(.+)/s);
    if(m)chunks.push({idx:m[1],score:m[2],text:m[3].trim()});
  }
  let chunksHtml=chunks.length?chunks.map(c=>{
    const sc=parseFloat(c.score);const col=sc>0.7?'var(--green)':sc>0.4?'var(--orange)':'var(--text-dim)';
    return`<div class="apv-chunk"><div class="apv-chunk-hdr"><span class="apv-chunk-idx">Chunk ${c.idx}</span><span class="apv-chunk-score" style="color:${col};background:${col}20">${(sc*100).toFixed(0)}%</span></div><div class="apv-chunk-text">${escA(c.text.slice(0,300))}</div></div>`;
  }).join(''):`<div style="font-size:11px;color:var(--text-dim);padding:8px">${escA(out.slice(0,500))}</div>`;
  const svgSearch='<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/><line x1="16.5" y1="16.5" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
  return`<div class="apv-rag"><div class="apv-qbar">${svgSearch}<span>${escA(query)}</span></div>${chunksHtml}</div>`;
}

function renderEmailSearchView(step){
  const inp=typeof step.input==='object'?step.input:{};
  const query=inp.query||inp.sender||inp.subject||'';
  const out=String(step.output||'');
  const emails=[];
  const lines=out.split('\n').filter(l=>l.trim());
  for(const line of lines){
    const m=line.match(/^UID:\s*(\S+)\s*\|\s*From:\s*(.*?)\s*\|\s*Subject:\s*(.*?)\s*\|\s*Date:\s*(.*)$/);
    if(m)emails.push({uid:m[1],from:m[2],subject:m[3],date:m[4]});
  }
  let listHtml=emails.length?emails.map(e=>
    `<div class="apv-email-item"><div class="apv-email-from">${escA(e.from)}</div><div class="apv-email-subj">${escA(e.subject)}</div><div class="apv-email-date">${escA(e.date)}</div></div>`
  ).join(''):`<div style="font-size:11px;color:var(--text-dim);padding:8px">${escA(out.slice(0,500))}</div>`;
  return`<div class="apv-email"><div class="apv-email-hdr"><span style="font-size:16px">&#9993;</span> <span>Inbox Search: ${escA(query)}</span> <span class="apv-email-count">${emails.length} results</span></div><div class="apv-email-list">${listHtml}</div></div>`;
}

function renderEmailReadView(step){
  const uid=typeof step.input==='object'?(step.input.uid||''):String(step.input||'');
  const out=String(step.output||'');
  // Parse header fields
  const fromM=out.match(/^From:\s*(.*)$/m);
  const toM=out.match(/^To:\s*(.*)$/m);
  const subjM=out.match(/^Subject:\s*(.*)$/m);
  const dateM=out.match(/^Date:\s*(.*)$/m);
  const attM=out.match(/^Attachments:\s*(.*)$/m);
  // Body is everything after the headers
  const bodyStart=out.indexOf('\n\n');
  const body=bodyStart>=0?out.slice(bodyStart+2):'';
  return`<div class="apv-email"><div class="apv-email-hdr"><span style="font-size:16px">&#9993;</span> <span>${escA(subjM?subjM[1]:'Email')}</span></div><div class="apv-email-meta"><div><strong>From:</strong> ${escA(fromM?fromM[1]:'')}</div><div><strong>To:</strong> ${escA(toM?toM[1]:'')}</div><div><strong>Date:</strong> ${escA(dateM?dateM[1]:'')}</div>${attM?'<div><strong>Attachments:</strong> '+escA(attM[1])+'</div>':''}</div><div class="apv-email-body">${escA(body.slice(0,2000))}</div></div>`;
}

function renderCalcView(step){
  const expr=typeof step.input==='object'?(step.input.expression||''):String(step.input||'');
  const result=String(step.output||'');
  return`<div class="apv-calc"><div class="apv-expr">${escA(expr)}</div><div class="apv-eq">=</div><div class="apv-result">${escA(result)}</div></div>`;
}

function renderClockView(step){
  const out=String(step.output||'');
  // Parse German datetime format "Montag, 24. Februar 2026, 14:30:45 Uhr"
  const timeM=out.match(/(\d{1,2}:\d{2}:\d{2})/);
  const timeStr=timeM?timeM[1]:out;
  const dateStr=out.replace(/,?\s*\d{1,2}:\d{2}:\d{2}\s*Uhr\s*$/,'').trim();
  return`<div class="apv-clock"><div class="apv-time">${escA(timeStr)}</div><div class="apv-date">${escA(dateStr)}</div></div>`;
}

function renderGenericToolView(step){
  const inp=typeof step.input==='object'?JSON.stringify(step.input,null,2):String(step.input||'');
  const out=String(step.output||'').slice(0,1000);
  return`<div class="apv-generic"><span class="apv-gtool">${escA(step.tool)}</span><div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">Step ${step.step} &mdash; ${step.duration_ms}ms</div><div class="apv-glabel">Input</div><div class="apv-gblock">${escA(inp)}</div><div class="apv-glabel">Output</div><div class="apv-gblock">${escA(out)}</div></div>`;
}

function renderAgentDone(d){
  const isErr=d.error===true;
  if(isErr){
    $('apViewer').innerHTML=`<div class="apv-done"><div class="apv-done-check" style="background:rgba(248,81,73,.15);color:var(--red)">!</div><div class="apv-done-label" style="color:var(--red)">Agent Error</div><div style="font-size:11px;color:var(--text-dim);text-align:center;padding:0 12px">${escA(String(d.answer||''))}</div></div>`;
  } else {
    $('apViewer').innerHTML=`<div class="apv-done"><div class="apv-done-check">&#10003;</div><div class="apv-done-label">Agent Complete</div><div class="apv-done-stats"><span>${d.total_steps} steps</span><span>${fmtDur(d.duration_ms)}</span></div></div>`;
  }
}

function escA(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ---- Feed ----
function renderFeed(){$('feedBody').innerHTML='';getFiltered().forEach(e=>addFeedItem(e,false));scrollFeed()}
function getFiltered(){
  if(activeFilter==='all')return events.filter(e=>!e.type.startsWith('_'));
  if(activeFilter==='flagged')return events.filter(e=>moderation[e.id]?.flagged);
  return events.filter(e=>e.type===activeFilter);
}
function addFeedItem(evt,scroll=true){
  if(evt.type.startsWith('_'))return;
  if(activeFilter!=='all'){if(activeFilter==='flagged'){if(!moderation[evt.id]?.flagged)return}else if(evt.type!==activeFilter)return}
  const body=$('feedBody'),d=document.createElement('div');
  d.className='fi'+(evt.id===selectedId?' sel':'')+(moderation[evt.id]?.flagged?' flagged':'');
  d.dataset.id=evt.id;d.onclick=()=>{selectEvent(evt.id);cTab('detail')};
  const fl=moderation[evt.id]?.flagged?' <span style="color:var(--red)">&#9873;</span>':'';
  d.innerHTML=`<div class="ft ${evt.type}">${evt.type}${fl}</div><div class="fp">${esc(preview(evt))}</div><div class="fm"><span>${fmtTime(evt.timestamp)}</span>${evt.user_id?`<span>${esc(evt.user_id)}</span>`:''}${evt.duration_ms?`<span>${evt.duration_ms}ms</span>`:''}</div>`;
  body.appendChild(d);$('feedCount').textContent=body.children.length;if(scroll)scrollFeed();
}
function preview(e){switch(e.type){case'chat':return e.question||'';case'query':return e.sql||'';case'error':return e.message||'';case'system':return`[${e.action||''}] ${e.message||''}`;default:return JSON.stringify(e).slice(0,80)}}
function scrollFeed(){const b=$('feedBody');b.scrollTop=b.scrollHeight}
$('feedFilters').addEventListener('click',e=>{if(!e.target.classList.contains('fbtn'))return;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on','on-red'));const f=e.target.dataset.f;e.target.classList.add(f==='flagged'?'on-red':'on');activeFilter=f;renderFeed()});

// ---- Detail ----
function selectEvent(id){selectedId=id;document.querySelectorAll('.fi').forEach(el=>el.classList.toggle('sel',el.dataset.id===id));renderDetail(id)}
function renderDetail(id){
  const evt=events.find(e=>e.id===id);if(!evt)return;
  const body=$('detailBody'),mb=$('modBar');
  if(currentUser?.role==='admin')mb.style.display='flex';
  const mod=moderation[id]||{};
  $('btnFlag').className='mbtn'+(mod.flagged?' fon':'');$('btnFlag').textContent=mod.flagged?'Unflag':'Flag';
  $('btnReview').className='mbtn'+(mod.reviewed?' ron':'');$('btnReview').textContent=mod.reviewed?'Reviewed':'Mark Reviewed';
  $('noteIn').value=mod.note||'';
  if(evt.type==='chat'){const tb=timeBadge(evt.duration_ms);body.innerHTML=`<div class="dmeta">${evt.model?`<span class="badge bmod">${esc(evt.model)}</span>`:''}${evt.duration_ms?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="bubble q" style="max-width:100%"><div class="bl">User</div>${esc(evt.question||'')}</div><div class="bubble a" style="max-width:100%"><div class="bl">Bot</div>${esc(evt.answer||'')}</div>`}
  else if(evt.type==='query'){const tb=timeBadge(evt.duration_ms);let h=`<div class="dmeta">${evt.duration_ms!=null?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="sqlb">${hlSQL(evt.sql||'')}</div>`;if(evt.error)h+=`<div class="qerr">${esc(evt.error)}</div>`;if(evt.results?.length>0)h+=rtbl(evt.results);body.innerHTML=h}
  else if(evt.type==='error'){body.innerHTML=`<div class="dmeta"><span class="badge berr">${esc(evt.error_type||'error')}</span>${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="edetail"><div style="color:var(--red);font-weight:600;font-size:14px;margin-bottom:6px">${esc(evt.error_type||'Error')}</div><div style="line-height:1.5">${esc(evt.message||'')}</div>${evt.details?`<div style="margin-top:8px;padding:8px;background:var(--surface);border-radius:6px;font-family:monospace;font-size:12px;color:var(--text-dim);white-space:pre-wrap">${esc(evt.details)}</div>`:''}</div>`}
  else{body.innerHTML=`<div class="dmeta"><span class="badge btime">${fmtTime(evt.timestamp)}</span></div><div class="sysdetail"><div style="font-weight:600;font-size:14px;margin-bottom:6px">${esc(evt.action||'system')}</div><div style="color:var(--text-dim)">${esc(evt.message||'')}</div></div>`}
}

// ---- SQL ----
function renderSql(){
  const body=$('sqlBody'),qs=events.filter(e=>e.type==='query');
  const badge=$('sqlBadge');if(qs.length>0){badge.textContent=qs.length;badge.classList.remove('hide')}else{badge.classList.add('hide')}
  if(!qs.length){body.innerHTML='<div class="dempty">SQL queries will appear here</div>';return}
  body.innerHTML='';qs.slice(-50).forEach(e=>addSqlItem(e,false));body.scrollTop=body.scrollHeight;
}
function addSqlItem(evt,scroll=true){
  const body=$('sqlBody');if(body.querySelector('.dempty'))body.innerHTML='';
  const badge=$('sqlBadge'),cnt=events.filter(e=>e.type==='query').length;badge.textContent=cnt;badge.classList.remove('hide');
  const d=document.createElement('div');d.style.marginBottom='10px';const tb=timeBadge(evt.duration_ms);
  let h=`<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">${evt.duration_ms!=null?`<span class="badge ${tb}">${evt.duration_ms}ms</span>`:''}${evt.user_id?`<span class="badge buser">${esc(evt.user_id)}</span>`:''}<span style="font-size:10px;color:var(--text-dim)">${fmtTime(evt.timestamp)}</span></div><div class="sqlb" style="cursor:pointer" onclick="selectEvent('${evt.id}');cTab('detail')">${hlSQL(evt.sql||'')}</div>`;
  if(evt.error)h+=`<div class="qerr">${esc(evt.error)}</div>`;else if(evt.results?.length>0)h+=rtbl(evt.results);
  d.innerHTML=h;body.appendChild(d);if(scroll)body.scrollTop=body.scrollHeight;
}
function rtbl(rows){if(!rows.length)return'';const cols=Object.keys(rows[0]);let h='<div style="overflow-x:auto"><table class="rtbl"><thead><tr>';cols.forEach(c=>h+=`<th>${esc(String(c))}</th>`);h+='</tr></thead><tbody>';rows.forEach(r=>{h+='<tr>';cols.forEach(c=>h+=`<td title="${esc(String(r[c]??''))}">${esc(String(r[c]??''))}</td>`);h+='</tr>'});h+='</tbody></table></div>';return h}

// ---- Users ----
function renderUsers(){
  if(currentUser?.role!=='admin')return;
  const body=$('usersBody'),list=Object.values(usersMap).sort((a,b)=>(b.last_seen||0)-(a.last_seen||0));
  const badge=$('usersBadge');const blocked=list.filter(u=>u.status==='blocked').length;
  if(blocked>0){badge.textContent=blocked;badge.classList.remove('hide');badge.classList.add('red')}else{badge.classList.add('hide')}
  if(!list.length){body.innerHTML='<div class="dempty">No users yet</div>';return}
  body.innerHTML=list.map(u=>{
    const evts=events.filter(e=>e.user_id===u.user_id);
    const chatCount=evts.filter(e=>e.type==='chat').length;
    const lastAgo=u.last_seen?timeAgo(u.last_seen):'never';
    return`<div class="uitem${selectedUser===u.user_id?' sel':''}" onclick="showUserDetail('${esc(u.user_id)}')">
      <div class="udot ${u.status||'active'}"></div>
      <div class="uinfo"><div class="uname">${esc(u.user_id)}</div><div class="umeta">${chatCount} chats &middot; ${lastAgo}</div></div>
      <span class="ustatus ${u.status||'active'}">${u.status||'active'}</span>
    </div>`;
  }).join('');
}
function showUserDetail(uid){
  selectedUser=uid;renderUsers();
  const u=usersMap[uid]||{user_id:uid,status:'unknown'};
  const uevts=events.filter(e=>e.user_id===uid);
  const chats=uevts.filter(e=>e.type==='chat').length;
  const errs=uevts.filter(e=>e.type==='error').length;
  const queries=uevts.filter(e=>e.type==='query').length;
  const isBlocked=u.status==='blocked';
  const priority=u.priority||'normal';
  const body=$('usersBody');
  body.innerHTML=`
    <div style="padding:4px">
      <button class="mbtn" onclick="selectedUser=null;renderUsers()" style="margin-bottom:8px">&larr; All Users</button>
      <div class="ucard">
        <h3><div class="udot ${u.status||'active'}" style="width:10px;height:10px"></div> ${esc(uid)}</h3>
        <div class="ustat-grid">
          <div class="ustat-item"><strong>${chats}</strong> chats</div>
          <div class="ustat-item"><strong>${queries}</strong> queries</div>
          <div class="ustat-item"><strong>${errs}</strong> errors</div>
          <div class="ustat-item"><strong>${uevts.length}</strong> total events</div>
          <div class="ustat-item">First: <strong>${u.first_seen?fmtTime(u.first_seen):'?'}</strong></div>
          <div class="ustat-item">Last: <strong>${u.last_seen?timeAgo(u.last_seen):'?'}</strong></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
        ${isBlocked
          ?`<button class="ubtn unblock" onclick="userAction('${esc(uid)}','unblock')">Unblock User</button>`
          :`<button class="ubtn block" onclick="userAction('${esc(uid)}','block')">Block User</button>`}
        <label style="font-size:10px;color:var(--text-dim);margin-left:8px">Priority</label>
        <select style="padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px" onchange="setUserPriority('${esc(uid)}',this.value)">
          <option value="high"${priority==='high'?' selected':''}>High</option>
          <option value="normal"${priority==='normal'?' selected':''}>Normal</option>
          <option value="low"${priority==='low'?' selected':''}>Low</option>
        </select>
      </div>
      ${u.note?`<div class="ucard"><div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">ADMIN NOTE</div><div style="font-size:12px">${esc(u.note)}</div></div>`:''}
      <div class="stitle">Recent Activity</div>
      ${uevts.slice(-20).reverse().map(e=>`<div class="uevt" onclick="selectEvent('${e.id}');cTab('detail')"><span class="ft ${e.type}" style="display:inline">${e.type}</span> <span style="color:var(--text-dim)">${esc(preview(e)).slice(0,60)}</span> <span style="font-size:10px;color:var(--text-dim);float:right">${fmtTime(e.timestamp)}</span></div>`).join('')}
      ${uevts.length===0?'<div style="color:var(--text-dim);font-size:11px">No activity</div>':''}
    </div>`;
}
async function userAction(uid,action){
  await fetch(`/api/users/${uid}/${action}`,{method:'POST'});
}
async function setUserPriority(uid,priority){
  await fetch(`/api/users/${uid}/update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({priority})});
  if(usersMap[uid])usersMap[uid].priority=priority;
}

// ---- Accounts ----
async function loadAccounts(){
  try{
    const r=await fetch('/api/accounts');const d=await r.json();
    renderAccounts(d.accounts||[]);
  }catch(e){$('accountsBody').innerHTML='<div class="dempty">Error loading accounts</div>'}
}
function renderAccounts(accts){
  const body=$('accountsBody');
  if(!accts.length){body.innerHTML='<div class="dempty">No accounts</div>';return}
  body.innerHTML=`
    <div style="margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div class="stitle" style="margin:0">Bot Control</div>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;cursor:pointer;margin-left:auto">
          <input type="checkbox" id="botToggle" onchange="toggleBot(this.checked)" ${appCfg.bot_enabled!==false?'checked':''}>
          <span style="color:${appCfg.bot_enabled!==false?'var(--green)':'var(--red)'}" id="botLabel">${appCfg.bot_enabled!==false?'Bot Enabled':'Bot Disabled'}</span>
        </label>
      </div>
    </div>
    <div class="stitle">Dashboard Accounts</div>
    ${accts.map(a=>`
      <div class="ucard" style="padding:8px 10px;margin-bottom:6px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-weight:600;font-size:13px">${esc(a.username)}</span>
          <span class="role-badge ${a.role}">${a.role}</span>
          <span style="font-size:10px;color:var(--text-dim);margin-left:auto">priority: ${a.priority||'normal'}</span>
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
          <select style="padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:10px" onchange="setAccountRole('${esc(a.username)}',this.value)">
            <option value="admin"${a.role==='admin'?' selected':''}>admin</option>
            <option value="mitarbeiter"${a.role==='mitarbeiter'?' selected':''}>mitarbeiter</option>
            <option value="user"${a.role==='user'?' selected':''}>user</option>
          </select>
          <select style="padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:10px" onchange="setAccountPriority('${esc(a.username)}',this.value)">
            <option value="high"${a.priority==='high'?' selected':''}>high</option>
            <option value="normal"${(a.priority||'normal')==='normal'?' selected':''}>normal</option>
            <option value="low"${a.priority==='low'?' selected':''}>low</option>
          </select>
          ${a.username!==currentUser?.username?`<button class="mbtn" style="padding:2px 8px;font-size:10px;color:var(--red);margin-left:auto" onclick="deleteAccount('${esc(a.username)}')">Delete</button>`:''}
        </div>
      </div>
    `).join('')}`;
}
async function toggleBot(enabled){
  await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_enabled:enabled})});
  appCfg.bot_enabled=enabled;
  const lbl=$('botLabel');if(lbl){lbl.textContent=enabled?'Bot Enabled':'Bot Disabled';lbl.style.color=enabled?'var(--green)':'var(--red)'}
}
async function setAccountRole(username,role){
  await fetch(`/api/accounts/${username}/role`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});
  loadAccounts();
}
async function setAccountPriority(username,priority){
  await fetch(`/api/accounts/${username}/priority`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({priority})});
  loadAccounts();
}
async function deleteAccount(username){
  if(!confirm(`Delete account "${username}"?`))return;
  const r=await fetch(`/api/accounts/${username}/delete`,{method:'POST'});
  const d=await r.json();
  if(d.error)alert(d.error);
  loadAccounts();
}

// ---- Stats ----
function refreshStats(){
  if(currentUser?.role!=='admin')return;
  fetch('/api/stats').then(r=>{if(!r.ok)throw new Error();return r.json()}).then(s=>{
    renderStats(s);$('hUsers').textContent=s.active_users;$('hChats').textContent=s.total_chats;$('hErrors').textContent=s.total_errors;$('hAvg').textContent=s.avg_response_ms+'ms';
  }).catch(()=>{});
}
function renderStats(s){
  $('statsBody').innerHTML=`
    <div class="sgrid">
      <div class="sc"><div class="sl">Active Users</div><div class="sv" style="color:var(--cyan)">${s.active_users}</div><div class="ssub">${s.total_users||0} total, ${s.blocked_users||0} blocked</div></div>
      <div class="sc"><div class="sl">Avg Response</div><div class="sv" style="color:${s.avg_response_ms>5000?'var(--red)':s.avg_response_ms>2000?'var(--orange)':'var(--green)'}">${fmtDur(s.avg_response_ms)}</div><div class="ssub">per chat</div></div>
      <div class="sc"><div class="sl">Error Rate</div><div class="sv" style="color:${s.error_rate>5?'var(--red)':s.error_rate>1?'var(--orange)':'var(--green)'}">${s.error_rate}%</div><div class="ssub">${s.total_errors} total</div></div>
      <div class="sc"><div class="sl">Msgs/Hour</div><div class="sv" style="color:var(--accent)">${s.messages_last_hour}</div><div class="ssub">${s.total_chats} total</div></div>
    </div>
    <div class="stitle">Hourly Volume (24h)</div><div class="sc" style="padding:8px">${barChart(s.hourly||{})}</div>
    <div class="stitle">Event Types</div><div class="sc" style="padding:8px">${typeBar(s.type_counts||{})}</div>
    <div class="stitle">Top Topics</div><div class="tlist" style="margin-bottom:12px">${(s.topics||[]).map(t=>`<span class="ttag">${esc(t)}</span>`).join('')||'<span style="color:var(--text-dim);font-size:11px">No topics yet</span>'}</div>
    <div class="stitle">Moderation</div><div class="sc"><div style="display:flex;gap:16px;font-size:12px"><span style="color:var(--red)">Flagged: ${s.flagged||0}</span><span style="color:var(--orange)">Unreviewed: ${s.unreviewed||0}</span><span style="color:var(--green)">Reviewed: ${s.reviewed||0}</span></div></div>`;
}
function barChart(h){const e=Object.entries(h);if(!e.length)return'<div style="color:var(--text-dim);font-size:11px;text-align:center;padding:10px">No data</div>';const mx=Math.max(...e.map(x=>x[1]),1);let r='<div class="barchart">';e.forEach(([hr,c])=>r+=`<div class="bar" style="height:${Math.max(c/mx*100,3)}%" data-label="${hr}: ${c}"></div>`);r+='</div><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim)"><span>'+e[0][0]+'</span>'+(e.length>1?'<span>'+e[e.length-1][0]+'</span>':'')+'</div>';return r}
function typeBar(c){const t=Object.values(c).reduce((a,b)=>a+b,0)||1;const cl={chat:'var(--accent)',query:'var(--purple)',error:'var(--red)',system:'var(--text-dim)'};let h='<div style="display:flex;height:20px;border-radius:4px;overflow:hidden;margin-bottom:6px">';Object.entries(c).forEach(([k,v])=>{if(v>0)h+=`<div style="width:${v/t*100}%;background:${cl[k]||'var(--text-dim)'}" title="${k}: ${v}"></div>`});h+='</div><div style="display:flex;gap:12px;flex-wrap:wrap">';Object.entries(c).forEach(([k,v])=>h+=`<span style="font-size:11px;color:${cl[k]||'var(--text-dim)'}">${k}: ${v}</span>`);h+='</div>';return h}

// ---- Moderation ----
function toggleFlag(){if(!selectedId)return;postMod(selectedId,{flagged:!(moderation[selectedId]?.flagged)})}
function toggleReview(){if(!selectedId)return;postMod(selectedId,{reviewed:!(moderation[selectedId]?.reviewed)})}
function saveNote(){if(!selectedId)return;postMod(selectedId,{note:$('noteIn').value})}
function postMod(id,d){fetch(`/api/moderate/${id}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(()=>{})}

// ---- Settings ----
let _loadedOpenaiKey='',_loadedAnthropicKey='',_loadedEmailPassword=''; // track masked values from server
function openSettings(){loadCfg();$('settingsModal').classList.add('open')}
function closeSettings(){$('settingsModal').classList.remove('open')}
function onProviderChange(){
  const p=$('cfgProvider').value;
  $('cfgOllamaRow').style.display=p==='ollama'?'':'none';
  $('cfgOpenaiOAuthRow').style.display=p==='openai'?'':'none';
  $('cfgOpenaiKeyRow').style.display=p==='openai'?'':'none';
  $('cfgOpenaiUrlRow').style.display=p==='openai'?'':'none';
  $('cfgAnthropicKeyRow').style.display=p==='anthropic'?'':'none';
  $('cfgOpenrouterRow').style.display=p==='openrouter'?'':'none';
  // DSGVO warning
  $('dsgvoSettingsWarn').style.display=p!=='ollama'?'':'none';
  // Update OpenAI OAuth status
  if(p==='openai'){
    const token=appCfg.openai_oauth_token||'';
    const st=$('oaiStatus');
    if(token&&token.startsWith('...')){st.textContent='Connected via OAuth';st.style.color='var(--green)';$('oaiLoginBtn').textContent='Reconnect'}
    else{st.textContent='Not connected';st.style.color='var(--text-dim)';$('oaiLoginBtn').textContent='Login with OpenAI'}
  }
  // Update OpenRouter status
  if(p==='openrouter'){
    const key=appCfg.openrouter_api_key||'';
    const st=$('orStatus');
    if(key&&key.startsWith('...')){st.textContent='Connected';st.style.color='var(--green)';$('orLoginBtn').textContent='Reconnect'}
    else{st.textContent='Not connected';st.style.color='var(--text-dim)';$('orLoginBtn').textContent='Login with OpenRouter'}
  }
}
function toggleKeyVis(id,btn){
  const inp=$(id);
  if(inp.type==='password'){inp.type='text';btn.textContent='Hide'}
  else{inp.type='password';btn.textContent='Show'}
}
function loginOpenRouter(){
  const callbackUrl=window.location.origin+'/';
  window.location.href='https://openrouter.ai/auth?callback_url='+encodeURIComponent(callbackUrl);
}
async function loginOpenAI(){
  try{
    const r=await fetch('/api/openai/auth/start',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const d=await r.json();
    if(d.auth_url&&d.state){
      localStorage.setItem('openai_oauth_state',d.state);
      window.location.href=d.auth_url;
    }else{
      alert('Failed to start OpenAI login: '+(d.error||'Unknown error'));
    }
  }catch(e){alert('OpenAI login failed: '+e.message)}
}
async function handleOpenAICallback(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get('code');
  const state=params.get('state');
  if(!code||!state)return false;
  const savedState=localStorage.getItem('openai_oauth_state');
  if(!savedState||savedState!==state)return false; // Not our OAuth flow
  localStorage.removeItem('openai_oauth_state');
  // Clean URL
  window.history.replaceState({},'',window.location.pathname);
  try{
    const r=await fetch('/api/auth/me');
    if(!r.ok)return false; // need to be logged in first
    const er=await fetch('/api/openai/auth/callback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,state})});
    const d=await er.json();
    if(d.ok){
      alert('OpenAI connected! Provider switched to OpenAI.');
      return true;
    }else{
      alert('OpenAI error: '+(d.error||'Unknown error'));
    }
  }catch(e){alert('OpenAI exchange failed: '+e.message)}
  return false;
}
async function handleOpenRouterCallback(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get('code');
  if(!code)return false;
  // If state param is present and matches our OpenAI state, it's not OpenRouter
  const state=params.get('state');
  if(state&&localStorage.getItem('openai_oauth_state'))return false;
  // Clean URL
  window.history.replaceState({},'',window.location.pathname);
  try{
    const r=await fetch('/api/auth/me');
    if(!r.ok)return false; // need to be logged in first
    const er=await fetch('/api/openrouter/exchange',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
    const d=await er.json();
    if(d.ok){
      alert('OpenRouter connected! Provider switched to OpenRouter.');
      return true;
    }else{
      alert('OpenRouter error: '+(d.error||'Unknown error'));
    }
  }catch(e){alert('OpenRouter exchange failed: '+e.message)}
  return false;
}
async function newChat(){
  try{
    await fetch('/api/chat/clear',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
  }catch(e){}
  chatHistory=[];
  renderChatMsgs();
  $('chatInput').focus();
}

// ---- Admin Chat Viewer ----
async function loadUserChatSessions(){
  if(currentUser?.role!=='admin')return;
  try{
    const r=await fetch('/api/admin/chats');if(!r.ok)return;
    const d=await r.json();adminChatSessions=d.sessions||[];
    renderUserChatSessions();
  }catch(e){}
}
function renderUserChatSessions(){
  const body=$('userChatsBody');
  const badge=$('ucBadge');
  if(adminChatSessions.length>0){badge.textContent=adminChatSessions.length;badge.classList.remove('hide')}else{badge.classList.add('hide')}
  if(!adminChatSessions.length){body.innerHTML='<div class="dempty">No active chat sessions</div>';return}
  body.innerHTML=adminChatSessions.map(s=>{
    const lastAgo=s.last_activity?timeAgo(s.last_activity):'—';
    const isViewing=viewingSessionId===s.session_id;
    return`<div class="fi${isViewing?' sel':''}" onclick="viewAdminChat('${esc(s.session_id)}')">
      <div class="ft chat" style="display:flex;align-items:center;gap:6px">
        <span>${esc(s.username||'anonymous')}</span>
        <span style="font-size:9px;font-weight:400;color:var(--text-dim)">${s.message_count} msgs</span>
      </div>
      <div class="fp">${esc(s.model||'—')}</div>
      <div class="fm"><span>${lastAgo}</span></div>
    </div>`;
  }).join('');
}
async function viewAdminChat(sessionId){
  viewingSessionId=sessionId;
  renderUserChatSessions();
  // Show the admin chat tab in center
  $('adminChatTab').style.display='';
  cTab('adminchat');
  await refreshAdminChat();
  // Start auto-refresh
  if(ucRefreshTimer)clearInterval(ucRefreshTimer);
  ucRefreshTimer=setInterval(refreshAdminChat,2000);
}
async function refreshAdminChat(){
  if(!viewingSessionId)return;
  try{
    const r=await fetch('/api/admin/chats/'+viewingSessionId);
    if(!r.ok){$('adminChatMessages').innerHTML='<div class="dempty">Session not found or expired</div>';return}
    const d=await r.json();
    const meta=d.meta||{};
    $('acUser').textContent=meta.username||'anonymous';
    $('acModel').textContent=meta.model||'—';
    $('acMsgCount').textContent=(d.messages||[]).length+' messages';
    $('acStarted').textContent=meta.created_at?'Started: '+fmtTime(meta.created_at):'';
    renderAdminChatMessages(d.messages||[]);
  }catch(e){}
}
function renderAdminChatMessages(messages){
  const c=$('adminChatMessages');
  if(!messages.length){c.innerHTML='<div class="dempty">No messages yet</div>';return}
  const wasAtBottom=c.scrollHeight-c.scrollTop-c.clientHeight<50;
  c.innerHTML=messages.map(m=>{
    const ts=m.timestamp?`<span style="font-size:10px;color:var(--text-dim)">${fmtTime(m.timestamp)}</span>`:'';
    if(m.role==='user')return`<div class="bubble q"><div class="bl">User ${ts}</div>${esc(m.content)}</div>`;
    return`<div class="bubble a"><div class="bl">Bot ${ts}</div>${esc(m.content)}</div>`;
  }).join('');
  if(wasAtBottom)c.scrollTop=c.scrollHeight;
}
let _loadedDbPassword='';
async function loadCfg(){
  try{
    const r=await fetch('/api/config');if(!r.ok)return;
    const d=await r.json();appCfg=d.config;
    $('cfgProvider').value=appCfg.provider||'ollama';
    $('cfgUrl').value=appCfg.ollama_url||'http://localhost:11434';
    $('cfgOpenaiUrl').value=appCfg.openai_base_url||'https://api.openai.com/v1';
    // API keys come masked from server (e.g. "...abcd")
    _loadedOpenaiKey=appCfg.openai_api_key||'';
    _loadedAnthropicKey=appCfg.anthropic_api_key||'';
    $('cfgOpenaiKey').value=_loadedOpenaiKey;
    $('cfgAnthropicKey').value=_loadedAnthropicKey;
    $('cfgPrompt').value=appCfg.system_prompt||'';
    $('cfgTemp').value=appCfg.temperature??0.7;
    // DB settings
    $('cfgDbEnabled').checked=!!appCfg.db_enabled;
    $('cfgDbType').value=appCfg.db_type||'';
    $('cfgDbMssqlServer').value=appCfg.db_mssql_server||'';
    $('cfgDbMssqlDatabase').value=appCfg.db_mssql_database||'';
    $('cfgDbMssqlUser').value=appCfg.db_mssql_user||'';
    _loadedDbPassword=appCfg.db_mssql_password||'';
    $('cfgDbMssqlPassword').value=_loadedDbPassword;
    $('cfgDbMssqlDriver').value=appCfg.db_mssql_driver||'ODBC Driver 17 for SQL Server';
    $('cfgDbSqlitePath').value=appCfg.db_sqlite_path||'';
    onDbTypeChange();
    // RAG settings
    $('cfgRagEnabled').checked=!!appCfg.rag_enabled;
    $('cfgEmbeddingProvider').value=appCfg.embedding_provider||'auto';
    $('cfgEmbeddingModel').value=appCfg.embedding_model||'';
    $('cfgRagTopK').value=appCfg.rag_top_k||5;
    // Agent settings
    $('cfgAgentEnabled').checked=!!appCfg.agent_enabled;
    $('cfgAgentMaxSteps').value=appCfg.agent_max_steps||8;
    $('cfgAgentWebSearch').checked=appCfg.agent_web_search!==false;
    // Email settings
    $('cfgEmailEnabled').checked=!!appCfg.email_enabled;
    $('cfgEmailImapServer').value=appCfg.email_imap_server||'outlook.office365.com';
    $('cfgEmailImapPort').value=appCfg.email_imap_port||993;
    $('cfgEmailAddress').value=appCfg.email_address||'';
    _loadedEmailPassword=appCfg.email_password||'';
    $('cfgEmailPassword').value=_loadedEmailPassword;
    onProviderChange();
    // DSGVO chat banner
    $('dsgvoChatBanner').style.display=appCfg._dsgvo_provider_block?'':'none';
    await loadModels();
    $('cfgModel').value=appCfg.default_model||'';
  }catch(e){}
}
async function saveSettings(){
  const provider=$('cfgProvider').value;
  const c={
    provider:provider,
    ollama_url:$('cfgUrl').value,
    default_model:$('cfgModel').value,
    system_prompt:$('cfgPrompt').value,
    temperature:parseFloat($('cfgTemp').value)||0.7,
    openai_base_url:$('cfgOpenaiUrl').value,
    // DB settings
    db_enabled:$('cfgDbEnabled').checked,
    db_type:$('cfgDbType').value,
    db_mssql_server:$('cfgDbMssqlServer').value,
    db_mssql_database:$('cfgDbMssqlDatabase').value,
    db_mssql_user:$('cfgDbMssqlUser').value,
    db_mssql_driver:$('cfgDbMssqlDriver').value,
    db_sqlite_path:$('cfgDbSqlitePath').value,
    // RAG settings
    rag_enabled:$('cfgRagEnabled').checked,
    embedding_provider:$('cfgEmbeddingProvider').value,
    embedding_model:$('cfgEmbeddingModel').value,
    rag_top_k:parseInt($('cfgRagTopK').value)||5,
    // Agent settings
    agent_enabled:$('cfgAgentEnabled').checked,
    agent_max_steps:parseInt($('cfgAgentMaxSteps').value)||8,
    agent_web_search:$('cfgAgentWebSearch').checked,
    // Email settings
    email_enabled:$('cfgEmailEnabled').checked,
    email_imap_server:$('cfgEmailImapServer').value,
    email_imap_port:parseInt($('cfgEmailImapPort').value)||993,
    email_address:$('cfgEmailAddress').value,
  };
  // Only send API key if user changed it (not the masked value)
  const okey=$('cfgOpenaiKey').value;
  if(okey&&okey!==_loadedOpenaiKey)c.openai_api_key=okey;
  const akey=$('cfgAnthropicKey').value;
  if(akey&&akey!==_loadedAnthropicKey)c.anthropic_api_key=akey;
  const dbpw=$('cfgDbMssqlPassword').value;
  if(dbpw&&dbpw!==_loadedDbPassword)c.db_mssql_password=dbpw;
  const empw=$('cfgEmailPassword').value;
  if(empw&&empw!==_loadedEmailPassword)c.email_password=empw;
  const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(c)});
  const d=await r.json();
  if(d.config)appCfg=d.config;
  // Update DSGVO banner
  $('dsgvoChatBanner').style.display=(appCfg._dsgvo_provider_block||appCfg.provider!=='ollama')?'':'none';
  closeSettings();
  // Reload models for possibly new provider
  await loadModels();
}
async function loadModels(){try{const r=await fetch('/api/models');if(!r.ok)return;ollamaModels=(await r.json()).models||[]}catch(e){ollamaModels=[]}populateModels()}
function populateModels(){[$('modelSel'),$('cfgModel')].forEach(s=>{if(!s)return;const c=s.value;s.innerHTML='';if(!ollamaModels.length){s.innerHTML='<option value="">No models found</option>';return}ollamaModels.forEach(m=>{const o=document.createElement('option');o.value=m.name;o.textContent=m.name;s.appendChild(o)});if(c&&ollamaModels.some(m=>m.name===c))s.value=c;else if(appCfg.default_model)s.value=appCfg.default_model})}
function clearEvents(){if(!confirm('Clear all events? This cannot be undone.'))return;fetch('/api/clear',{method:'POST'})}

// ---- Helpers ----
function $(id){return document.getElementById(id)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fmtTime(ts){if(!ts)return'';return new Date(ts*1000).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
function fmtDur(ms){if(ms>=1000)return(ms/1000).toFixed(1)+'s';return Math.round(ms)+'ms'}
function timeBadge(ms){if(!ms)return'btime';if(ms<100)return'bfast';if(ms<500)return'bmed';return'bslow'}
function timeAgo(ts){const s=Math.floor(Date.now()/1000-ts);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}
function hlSQL(sql){let r=esc(sql);r=r.replace(/('[^']*')/g,'<span class="ss">$1</span>');r=r.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|IN|IS|NULL|AS|ORDER BY|GROUP BY|HAVING|LIMIT|OFFSET|INSERT|INTO|VALUES|UPDATE|SET|DELETE|CREATE|ALTER|DROP|TABLE|INDEX|COUNT|SUM|AVG|MIN|MAX|DISTINCT|BETWEEN|LIKE|UNION|ALL|EXISTS|CASE|WHEN|THEN|ELSE|END|WITH)\b/gi,'<span class="sk">$1</span>');r=r.replace(/\b(\d+\.?\d*)\b/g,'<span class="sn">$1</span>');return r}

// ---- DB Settings UI ----
function onDbTypeChange(){
  const t=$('cfgDbType').value;
  $('cfgDbMssqlRows').style.display=t==='mssql'?'block':'none';
  $('cfgDbSqliteRows').style.display=t==='sqlite'?'block':'none';
}
async function testDbConnection(){
  const st=$('dbTestResult');st.textContent='Testing...';st.style.color='var(--text-dim)';
  // Save current settings first so the server has them
  await saveSettings();
  // Re-open settings since saveSettings closes the modal
  openSettings();
  try{
    const r=await fetch('/api/db/test',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const d=await r.json();
    if(d.ok){st.textContent='Connected! '+d.tables+' tables found.';st.style.color='var(--green)'}
    else{st.textContent='Error: '+(d.error||'Unknown');st.style.color='var(--red)'}
  }catch(e){st.textContent='Connection failed: '+e.message;st.style.color='var(--red)'}
}

async function testEmailConnection(){
  const st=$('emailTestResult');st.textContent='Testing...';st.style.color='var(--text-dim)';
  await saveSettings();
  openSettings();
  try{
    const r=await fetch('/api/email/test',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const d=await r.json();
    if(d.ok){st.textContent=d.message||'Connected!';st.style.color='var(--green)'}
    else{st.textContent='Error: '+(d.error||'Unknown');st.style.color='var(--red)'}
  }catch(e){st.textContent='Connection failed: '+e.message;st.style.color='var(--red)'}
}

// ---- SQL Run Query ----
async function runSqlQuery(){
  const sql=$('sqlRunInput').value.trim();if(!sql)return;
  const res=$('sqlRunResult');res.innerHTML='<span style="color:var(--text-dim);font-size:11px">Executing...</span>';
  try{
    const r=await fetch('/api/db/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sql})});
    const d=await r.json();
    if(d.error){res.innerHTML='<div class="qerr">'+esc(d.error)+'</div>';return}
    let h='<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">'+d.row_count+' rows, '+d.duration_ms+'ms</div>';
    if(d.rows?.length>0)h+=rtbl(d.rows);else h+='<div style="color:var(--text-dim);font-size:11px">No rows returned</div>';
    res.innerHTML=h;
  }catch(e){res.innerHTML='<div class="qerr">'+esc(e.message)+'</div>'}
}

// ---- Knowledge Base ----
async function loadKnowledge(){
  await Promise.all([loadKbDocs(),loadKbStats(),loadKbFolderFiles()]);
}

async function loadKbFolderFiles(){
  try{
    const r=await fetch('/api/knowledge/files');if(!r.ok)return;
    const d=await r.json();
    const fp=$('kbFolderPath');if(fp)fp.textContent=d.folder||'knowledge/';
    const el=$('kbFolderFiles');if(!el)return;
    if(!d.files?.length){el.innerHTML='<div style="font-size:10px;color:var(--text-dim);padding:4px">No files in folder yet. Drop files into the knowledge/ folder.</div>';return}
    el.innerHTML=d.files.map(f=>{
      const sz=f.size<1024?(f.size+'B'):f.size<1048576?((f.size/1024).toFixed(1)+'KB'):((f.size/1048576).toFixed(1)+'MB');
      const dot=f.indexed?'<span style="color:var(--green)" title="Indexed">&#9679;</span>':'<span style="color:var(--orange)" title="Not indexed">&#9675;</span>';
      return`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;border-bottom:1px solid rgba(48,54,61,.5)">${dot}<span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(f.path)}">${esc(f.path)}</span><span style="color:var(--text-dim);font-size:10px;white-space:nowrap">${sz}</span></div>`;
    }).join('');
  }catch(e){}
}

async function syncKnowledgeFolder(){
  const btn=$('btnKbSync');const st=$('kbSyncStatus');
  btn.disabled=true;st.textContent='Syncing...';st.style.color='var(--text-dim)';
  try{
    const r=await fetch('/api/knowledge/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const d=await r.json();
    if(d.ok){
      const parts=[];
      if(d.added)parts.push('+'+d.added+' added');
      if(d.updated)parts.push('~'+d.updated+' updated');
      if(d.deleted)parts.push('-'+d.deleted+' deleted');
      if(d.errors?.length)parts.push(d.errors.length+' errors');
      if(!parts.length)parts.push('Up to date');
      st.textContent=parts.join(', ');st.style.color='var(--green)';
      loadKnowledge();
    }else{st.textContent='Error: '+(d.error||'Unknown');st.style.color='var(--red)'}
  }catch(e){st.textContent='Failed: '+e.message;st.style.color='var(--red)'}
  btn.disabled=false;
}
let _kbViewingDoc=null; // currently expanded doc id
async function loadKbDocs(){
  try{
    const r=await fetch('/api/embeddings/documents');if(!r.ok)return;
    const d=await r.json();
    const list=$('kbDocList');
    if(!d.documents?.length){list.innerHTML='<div style="color:var(--text-dim);font-size:11px">No documents uploaded</div>';_kbViewingDoc=null;return}
    const isAdmin=currentUser?.role==='admin';
    list.innerHTML=d.documents.map(doc=>`
      <div class="ucard" style="padding:8px 10px;margin-bottom:4px;cursor:pointer" onclick="viewKbDoc('${esc(doc.id)}')" id="kbdoc-${doc.id}">
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-weight:600;font-size:12px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(doc.filename)}</span>
          <span style="font-size:10px;color:var(--text-dim);white-space:nowrap">${doc.chunk_count} chunks</span>
          ${isAdmin?`<button class="mbtn" style="padding:2px 6px;font-size:10px;color:var(--accent)" onclick="event.stopPropagation();editKbDoc('${esc(doc.id)}')">Edit</button>
          <button class="mbtn" style="padding:2px 6px;font-size:10px;color:var(--red)" onclick="event.stopPropagation();deleteKbDoc('${esc(doc.id)}')">Del</button>`:''}
        </div>
        <div style="font-size:10px;color:var(--text-dim)">${doc.uploaded_by||'?'} &middot; ${doc.uploaded_at?fmtTime(doc.uploaded_at):''}</div>
      </div>
      <div id="kbdetail-${doc.id}" style="display:none"></div>
    `).join('');
    // Re-expand if we were viewing one
    if(_kbViewingDoc)viewKbDoc(_kbViewingDoc);
  }catch(e){}
}
async function viewKbDoc(id){
  const detail=$('kbdetail-'+id);
  if(!detail)return;
  // Toggle
  if(_kbViewingDoc===id&&detail.style.display!=='none'){detail.style.display='none';_kbViewingDoc=null;return}
  // Collapse any other
  document.querySelectorAll('[id^="kbdetail-"]').forEach(el=>el.style.display='none');
  _kbViewingDoc=id;
  detail.style.display='block';
  detail.innerHTML='<div style="padding:8px;color:var(--text-dim);font-size:11px">Loading...</div>';
  try{
    const r=await fetch('/api/embeddings/documents/'+id);if(!r.ok){detail.innerHTML='<div style="color:var(--red);font-size:11px;padding:8px">Error loading</div>';return}
    const d=await r.json();const doc=d.document;
    detail.innerHTML=`
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:0 0 8px 8px;margin-top:-4px;margin-bottom:6px;padding:10px">
        <div style="font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;margin-bottom:6px">Content</div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;line-height:1.5;white-space:pre-wrap;max-height:200px;overflow-y:auto;color:var(--text)">${esc(doc.content)}</div>
        <div style="font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;margin:10px 0 6px">Chunks (${doc.chunks.length})</div>
        ${doc.chunks.map((ch,i)=>`
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 8px;margin-bottom:4px">
            <div style="display:flex;gap:6px;margin-bottom:2px">
              <span style="font-size:10px;font-weight:600;color:var(--accent)">#${ch.chunk_index}</span>
              <span style="font-size:10px;color:var(--text-dim)">${ch.token_count||'?'} tokens</span>
            </div>
            <div style="font-size:11px;line-height:1.4;color:var(--text);white-space:pre-wrap;max-height:100px;overflow-y:auto">${esc(ch.content)}</div>
          </div>
        `).join('')}
      </div>`;
  }catch(e){detail.innerHTML='<div style="color:var(--red);font-size:11px;padding:8px">'+esc(e.message)+'</div>'}
}
async function editKbDoc(id){
  // Fetch doc details first
  try{
    const r=await fetch('/api/embeddings/documents/'+id);if(!r.ok)return;
    const d=await r.json();const doc=d.document;
    // Collapse view and show editor in detail slot
    _kbViewingDoc=id;
    document.querySelectorAll('[id^="kbdetail-"]').forEach(el=>el.style.display='none');
    const detail=$('kbdetail-'+id);if(!detail)return;
    detail.style.display='block';
    detail.innerHTML=`
      <div style="background:var(--surface);border:1px solid var(--accent);border-radius:0 0 8px 8px;margin-top:-4px;margin-bottom:6px;padding:10px">
        <div style="font-size:11px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.3px;margin-bottom:6px">Edit Document</div>
        <div style="margin-bottom:6px">
          <label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:2px">TITLE</label>
          <input id="kbEditName" value="${esc(doc.filename).replace(/"/g,'&quot;')}" style="width:100%;padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;box-sizing:border-box">
        </div>
        <div style="margin-bottom:6px">
          <label style="font-size:10px;color:var(--text-dim);display:block;margin-bottom:2px">CONTENT <span style="font-weight:400">(editing will re-embed all chunks)</span></label>
          <textarea id="kbEditContent" rows="10" style="width:100%;padding:6px 8px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;line-height:1.5;resize:vertical;font-family:inherit;box-sizing:border-box">${esc(doc.content)}</textarea>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="mbtn" style="font-size:11px;color:var(--green);border-color:var(--green)" onclick="saveKbDoc('${esc(id)}')">Save</button>
          <button class="mbtn" style="font-size:11px" onclick="viewKbDoc('${esc(id)}')">Cancel</button>
          <span id="kbEditStatus" style="font-size:11px;margin-left:6px"></span>
        </div>
      </div>`;
  }catch(e){}
}
async function saveKbDoc(id){
  const st=$('kbEditStatus');
  const filename=$('kbEditName').value.trim();
  const content=$('kbEditContent').value;
  if(!filename){st.innerHTML='<span style="color:var(--red)">Title required</span>';return}
  st.innerHTML='<span style="color:var(--text-dim)">Saving & re-embedding...</span>';
  try{
    const r=await fetch('/api/embeddings/documents/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename,content})});
    const d=await r.json();
    if(d.ok){
      st.innerHTML='<span style="color:var(--green)">Saved!'+(d.re_embedded?' Re-embedded '+d.chunk_count+' chunks.':'')+'</span>';
      setTimeout(()=>{_kbViewingDoc=id;loadKnowledge()},800);
    }else st.innerHTML='<span style="color:var(--red)">Error: '+esc(d.error||'Unknown')+'</span>';
  }catch(e){st.innerHTML='<span style="color:var(--red)">'+esc(e.message)+'</span>'}
}
async function loadKbStats(){
  try{
    const r=await fetch('/api/embeddings/stats');if(!r.ok)return;
    const d=await r.json();
    const size=d.db_size_bytes>1048576?(d.db_size_bytes/1048576).toFixed(1)+' MB':d.db_size_bytes>1024?(d.db_size_bytes/1024).toFixed(0)+' KB':d.db_size_bytes+' B';
    $('kbStats').innerHTML=`<div style="display:flex;gap:16px;font-size:12px"><span>Docs: <strong>${d.documents}</strong></span><span>Chunks: <strong>${d.chunks}</strong></span><span>Size: <strong>${size}</strong></span></div>`;
  }catch(e){}
}
async function uploadKbFile(){
  const fileInput=$('kbFileInput');
  if(!fileInput.files?.length){$('kbUploadStatus').innerHTML='<span style="color:var(--red)">Select a file first</span>';return}
  const file=fileInput.files[0];
  const st=$('kbUploadStatus');st.innerHTML='<span style="color:var(--text-dim)">Uploading & embedding...</span>';
  const fd=new FormData();fd.append('file',file);
  try{
    const r=await fetch('/api/embeddings/upload',{method:'POST',body:fd});
    const d=await r.json();
    if(d.ok){st.innerHTML='<span style="color:var(--green)">Uploaded: '+esc(d.filename)+' ('+d.chunk_count+' chunks)</span>';fileInput.value='';loadKnowledge()}
    else st.innerHTML='<span style="color:var(--red)">Error: '+esc(d.error||'Unknown')+'</span>';
  }catch(e){st.innerHTML='<span style="color:var(--red)">'+esc(e.message)+'</span>'}
}
async function uploadKbText(){
  const title=$('kbTextTitle').value.trim()||'Untitled';
  const content=$('kbTextContent').value.trim();
  if(!content){$('kbUploadStatus').innerHTML='<span style="color:var(--red)">Enter some text</span>';return}
  const st=$('kbUploadStatus');st.innerHTML='<span style="color:var(--text-dim)">Embedding text...</span>';
  try{
    const r=await fetch('/api/embeddings/text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,content})});
    const d=await r.json();
    if(d.ok){st.innerHTML='<span style="color:var(--green)">Added: '+esc(d.filename)+' ('+d.chunk_count+' chunks)</span>';$('kbTextTitle').value='';$('kbTextContent').value='';loadKnowledge()}
    else st.innerHTML='<span style="color:var(--red)">Error: '+esc(d.error||'Unknown')+'</span>';
  }catch(e){st.innerHTML='<span style="color:var(--red)">'+esc(e.message)+'</span>'}
}
async function deleteKbDoc(id){
  if(!confirm('Delete this document and all its embeddings?'))return;
  try{
    await fetch('/api/embeddings/documents/'+id,{method:'DELETE'});
    loadKnowledge();
  }catch(e){}
}
async function searchKb(){
  const q=$('kbSearchInput').value.trim();if(!q)return;
  const res=$('kbSearchResults');res.innerHTML='<span style="color:var(--text-dim);font-size:11px">Searching...</span>';
  try{
    const r=await fetch('/api/embeddings/search?q='+encodeURIComponent(q));
    const d=await r.json();
    if(d.error){res.innerHTML='<span style="color:var(--red);font-size:11px">'+esc(d.error)+'</span>';return}
    if(!d.results?.length){res.innerHTML='<span style="color:var(--text-dim);font-size:11px">No results</span>';return}
    res.innerHTML=d.results.map(r=>{
      const simColor=r.similarity>0.7?'var(--green)':r.similarity>0.4?'var(--orange)':'var(--text-dim)';
      return`<div class="ucard" style="padding:6px 8px;margin-bottom:3px"><div style="display:flex;gap:6px;margin-bottom:2px"><span style="font-size:10px;font-weight:600;color:${simColor}">${(r.similarity*100).toFixed(1)}%</span><span style="font-size:10px;color:var(--text-dim)">${r.token_count||'?'} tokens</span></div><div style="font-size:11px;color:var(--text);line-height:1.4;max-height:60px;overflow:hidden">${esc(r.content.slice(0,200))}${r.content.length>200?'...':''}</div></div>`;
    }).join('');
  }catch(e){res.innerHTML='<span style="color:var(--red);font-size:11px">'+esc(e.message)+'</span>'}
}

// ---- Init ----
(async()=>{
  // Handle OAuth callbacks if ?code= is in URL
  if(window.location.search.includes('code=')){
    // Try OpenAI first (has state param), then OpenRouter
    const handled=await handleOpenAICallback();
    if(!handled)await handleOpenRouterCallback();
  }
  checkAuth();
})();
</script>
</body>
</html>
